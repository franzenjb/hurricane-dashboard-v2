<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hurricane Database - Red Cross Intelligence Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="atlantic-storms-enhanced.js"></script>
    <style>
        :root {
            --rc-red: #ED1B2E;
            --rc-dark-red: #B71234;
            --rc-gray: #6D6E70;
        }
        
        .rc-red { background-color: var(--rc-red); }
        .rc-dark-red { background-color: var(--rc-dark-red); }
        
        .impact-catastrophic { background: linear-gradient(90deg, #7F1D1D, #991B1B); }
        .impact-severe { background: linear-gradient(90deg, #DC2626, #EF4444); }
        .impact-major { background: linear-gradient(90deg, #EA580C, #F97316); }
        .impact-moderate { background: linear-gradient(90deg, #F59E0B, #FCD34D); }
        .impact-minor { background: linear-gradient(90deg, #10B981, #34D399); }
        
        .data-quality-bar {
            height: 4px;
            background: #e5e7eb;
            border-radius: 2px;
            overflow: hidden;
        }
        
        .data-quality-fill {
            height: 100%;
            transition: width 0.3s;
        }
        
        .tcr-available { color: #10B981; }
        .tcr-unavailable { color: #EF4444; }
        
        .storm-row:hover { background: #f9fafb; }
        .storm-selected { background: #fef2f2 !important; }
        
        .compare-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .filter-chip {
            display: inline-block;
            padding: 4px 12px;
            margin: 2px;
            background: #e5e7eb;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .filter-chip.active {
            background: var(--rc-red);
            color: white;
        }
        
        .stats-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .stats-number {
            font-size: 32px;
            font-weight: bold;
            color: var(--rc-red);
        }
        
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--rc-red);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .sortable-header {
            cursor: pointer;
            user-select: none;
            position: relative;
            padding-right: 20px;
        }
        
        .sortable-header:hover {
            background-color: #f3f4f6;
        }
        
        .sort-indicator {
            position: absolute;
            right: 4px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 10px;
            color: #6b7280;
        }
        
        .sort-indicator.active {
            color: var(--rc-red);
        }
        
        /* Ensure Leaflet map displays properly in modal */
        #trackMap {
            z-index: 1;
        }
        
        .leaflet-container {
            background: #e5e5e5;
        }
    </style>
    <script src="tcr-links.js"></script>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <div class="bg-white shadow-md border-b-4 border-red-600">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <div class="w-12 h-12 bg-red-600 rounded-full flex items-center justify-center text-white font-bold mr-4">RC</div>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">Hurricane Intelligence Database</h1>
                        <p class="text-sm text-gray-600">American Red Cross - Disaster Services</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-sm text-gray-600">
                        <span class="font-bold text-2xl text-red-600" id="totalStorms">1,991</span> storms
                    </span>
                    <span class="text-sm text-gray-600">
                        <span class="font-bold text-lg text-orange-600" id="selectedCount">0</span> selected
                    </span>
                    <button id="compareBtn" class="hidden bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 transition-colors" onclick="showComparison()">
                        Compare Selected
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Bar -->
    <div class="bg-gray-100 py-4">
        <div class="max-w-7xl mx-auto px-4">
            <div class="grid grid-cols-2 md:grid-cols-6 gap-4">
                <div class="stats-card">
                    <div class="stats-number" id="catastrophicCount">0</div>
                    <div class="text-xs text-gray-600">CATASTROPHIC</div>
                </div>
                <div class="stats-card">
                    <div class="stats-number" id="severeCount">0</div>
                    <div class="text-xs text-gray-600">SEVERE</div>
                </div>
                <div class="stats-card">
                    <div class="stats-number" id="rcResponseCount">0</div>
                    <div class="text-xs text-gray-600">RC RESPONSES</div>
                </div>
                <div class="stats-card">
                    <div class="stats-number" id="tcrCount">0</div>
                    <div class="text-xs text-gray-600">TCR REPORTS</div>
                </div>
                <div class="stats-card">
                    <div class="stats-number" id="cat5Count">0</div>
                    <div class="text-xs text-gray-600">CATEGORY 5</div>
                </div>
                <div class="stats-card">
                    <div class="stats-number" id="narrativeCount">0</div>
                    <div class="text-xs text-gray-600">NARRATIVES</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 py-6">
        <!-- Filters -->
        <div class="bg-white rounded-lg shadow-md p-4 mb-6">
            <h2 class="text-lg font-bold mb-4">Advanced Filters</h2>
            
            <!-- Search -->
            <div class="mb-4">
                <input type="text" id="searchInput" placeholder="Search by name, year, state..." 
                       class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500">
            </div>
            
            <!-- Filter Chips -->
            <div class="flex flex-wrap gap-4">
                <!-- Impact Level -->
                <div>
                    <label class="text-sm font-bold text-gray-700">Impact Level:</label>
                    <div class="mt-1">
                        <span class="filter-chip" data-filter="impact" data-value="CATASTROPHIC">Catastrophic</span>
                        <span class="filter-chip" data-filter="impact" data-value="SEVERE">Severe</span>
                        <span class="filter-chip" data-filter="impact" data-value="MAJOR">Major</span>
                        <span class="filter-chip" data-filter="impact" data-value="MODERATE">Moderate</span>
                        <span class="filter-chip" data-filter="impact" data-value="MINOR">Minor</span>
                    </div>
                </div>
                
                <!-- Category -->
                <div>
                    <label class="text-sm font-bold text-gray-700">Category:</label>
                    <div class="mt-1">
                        <span class="filter-chip" data-filter="category" data-value="5">Cat 5</span>
                        <span class="filter-chip" data-filter="category" data-value="4">Cat 4</span>
                        <span class="filter-chip" data-filter="category" data-value="3">Cat 3</span>
                        <span class="filter-chip" data-filter="category" data-value="2">Cat 2</span>
                        <span class="filter-chip" data-filter="category" data-value="1">Cat 1</span>
                        <span class="filter-chip" data-filter="category" data-value="0">TS</span>
                        <span class="filter-chip" data-filter="category" data-value="-1">TD</span>
                    </div>
                </div>
                
                <!-- Special Filters -->
                <div>
                    <label class="text-sm font-bold text-gray-700">Special:</label>
                    <div class="mt-1">
                        <span class="filter-chip" data-filter="special" data-value="rc_response">RC Response</span>
                        <span class="filter-chip" data-filter="special" data-value="has_tcr">Has TCR</span>
                        <span class="filter-chip" data-filter="special" data-value="has_narrative">Has Narrative</span>
                        <span class="filter-chip" data-filter="special" data-value="high_quality">High Quality Data</span>
                        <span class="filter-chip" data-filter="special" data-value="exclude_td">Exclude TD</span>
                        <span class="filter-chip" data-filter="special" data-value="us_landfall">US Landfall Only</span>
                    </div>
                </div>
            </div>
            
            <!-- Landfall State Filter -->
            <div class="flex flex-wrap gap-2 mt-4">
                <label class="text-sm font-bold text-gray-700 w-full">Landfall States:</label>
                <div class="flex flex-wrap gap-1">
                    <span class="filter-chip" data-filter="state" data-value="FL">Florida</span>
                    <span class="filter-chip" data-filter="state" data-value="TX">Texas</span>
                    <span class="filter-chip" data-filter="state" data-value="LA">Louisiana</span>
                    <span class="filter-chip" data-filter="state" data-value="NC">North Carolina</span>
                    <span class="filter-chip" data-filter="state" data-value="SC">South Carolina</span>
                    <span class="filter-chip" data-filter="state" data-value="GA">Georgia</span>
                    <span class="filter-chip" data-filter="state" data-value="AL">Alabama</span>
                    <span class="filter-chip" data-filter="state" data-value="MS">Mississippi</span>
                    <span class="filter-chip" data-filter="state" data-value="VA">Virginia</span>
                    <span class="filter-chip" data-filter="state" data-value="NY">New York</span>
                    <span class="filter-chip" data-filter="state" data-value="NJ">New Jersey</span>
                    <span class="filter-chip" data-filter="state" data-value="MA">Massachusetts</span>
                    <span class="filter-chip" data-filter="state" data-value="CT">Connecticut</span>
                    <span class="filter-chip" data-filter="state" data-value="RI">Rhode Island</span>
                    <span class="filter-chip" data-filter="state" data-value="ME">Maine</span>
                    <span class="filter-chip" data-filter="state" data-value="MD">Maryland</span>
                    <span class="filter-chip" data-filter="state" data-value="DE">Delaware</span>
                </div>
            </div>
            
            <!-- Year Range -->
            <div class="flex items-center gap-4 mt-4">
                <label class="text-sm font-bold text-gray-700">Years:</label>
                <input type="number" id="yearStart" min="1851" max="2024" value="1980" class="w-20 px-2 py-1 border rounded">
                <span>to</span>
                <input type="number" id="yearEnd" min="1851" max="2024" value="2024" class="w-20 px-2 py-1 border rounded">
                <button onclick="applyFilters()" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">Apply</button>
                <button onclick="clearFilters()" class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700">Clear</button>
            </div>
        </div>

        <!-- Actions Bar -->
        <div class="bg-white rounded-lg shadow-md p-4 mb-4 flex justify-between items-center">
            <div class="flex gap-2">
                <button onclick="compareSelected()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 disabled:opacity-50" id="compareBtn" disabled>
                    Compare Selected
                </button>
                <button onclick="exportSelected()" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
                    Export CSV
                </button>
                <button onclick="viewOnMap()" class="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700">
                    View on Map
                </button>
            </div>
            <div class="text-sm text-gray-600">
                Showing <span id="visibleCount">0</span> of <span id="totalCount">1991</span> storms
            </div>
        </div>

        <!-- Data Table -->
        <div class="bg-white rounded-lg shadow-md overflow-hidden">
            <div class="overflow-x-auto">
                <table class="min-w-full">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">
                                <input type="checkbox" id="selectAll" class="compare-checkbox">
                            </th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider sortable-header" onclick="sortTable('storm_id')">
                                ID <span class="sort-indicator" id="sort-storm_id">‚áÖ</span>
                            </th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider sortable-header" onclick="sortTable('name')">
                                Name <span class="sort-indicator" id="sort-name">‚áÖ</span>
                            </th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider sortable-header" onclick="sortTable('year')">
                                Year <span class="sort-indicator" id="sort-year">‚áÖ</span>
                            </th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider sortable-header" onclick="sortTable('category')">
                                Cat <span class="sort-indicator" id="sort-category">‚áÖ</span>
                            </th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider sortable-header" onclick="sortTable('impact')">
                                Impact <span class="sort-indicator" id="sort-impact">‚áÖ</span>
                            </th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider sortable-header" onclick="sortTable('rc_score')">
                                RC Score <span class="sort-indicator" id="sort-rc_score">‚áÖ</span>
                            </th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider sortable-header" onclick="sortTable('states')">
                                States <span class="sort-indicator" id="sort-states">‚áÖ</span>
                            </th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider sortable-header" onclick="sortTable('deaths')">
                                Deaths <span class="sort-indicator" id="sort-deaths">‚áÖ</span>
                            </th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider sortable-header" onclick="sortTable('damage')">
                                Damage <span class="sort-indicator" id="sort-damage">‚áÖ</span>
                            </th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider sortable-header" onclick="sortTable('quality')">
                                Quality <span class="sort-indicator" id="sort-quality">‚áÖ</span>
                            </th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">TCR</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="stormTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Storms will be populated here -->
                    </tbody>
                </table>
            </div>
            
            <!-- Loading indicator -->
            <div id="loadingIndicator" class="hidden p-8 text-center">
                <div class="loading-spinner mx-auto"></div>
                <p class="mt-4 text-gray-600">Loading storms...</p>
            </div>
        </div>

        <!-- Pagination -->
        <div class="mt-4 flex justify-between items-center">
            <div>
                <select id="pageSize" onchange="changePageSize()" class="px-3 py-1 border rounded">
                    <option value="25">25 per page</option>
                    <option value="50">50 per page</option>
                    <option value="100">100 per page</option>
                    <option value="500">500 per page</option>
                </select>
            </div>
            <div class="flex gap-2">
                <button onclick="previousPage()" class="px-3 py-1 bg-gray-300 rounded hover:bg-gray-400" id="prevBtn">Previous</button>
                <span class="px-3 py-1">Page <span id="currentPage">1</span> of <span id="totalPages">1</span></span>
                <button onclick="nextPage()" class="px-3 py-1 bg-gray-300 rounded hover:bg-gray-400" id="nextBtn">Next</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let allStorms = ATLANTIC_STORMS_ENHANCED;
        let filteredStorms = [...allStorms];
        let selectedStorms = new Set();
        let currentPage = 1;
        let pageSize = 50;
        let sortColumn = 'year';
        let sortDirection = 'desc'; // 'asc' or 'desc'
        let activeFilters = {
            search: '',
            impact: [],
            category: [],
            special: [],
            state: [],
            yearStart: 1980, // Default to 1980 as in the HTML
            yearEnd: 2024
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            updateStats();
            applyFilters();
            setupEventListeners();
        });

        // Update statistics
        function updateStats() {
            document.getElementById('totalStorms').textContent = allStorms.length.toLocaleString();
            document.getElementById('catastrophicCount').textContent = 
                allStorms.filter(s => s.rc_impact_level === 'CATASTROPHIC').length;
            document.getElementById('severeCount').textContent = 
                allStorms.filter(s => s.rc_impact_level === 'SEVERE').length;
            document.getElementById('rcResponseCount').textContent = 
                allStorms.filter(s => s.rc_response?.responded).length;
            document.getElementById('cat5Count').textContent = 
                allStorms.filter(s => s.category === 5).length;
            document.getElementById('narrativeCount').textContent = 
                allStorms.filter(s => s.narrative).length;
            
            // Estimate TCR availability (post-1995 storms likely have TCRs)
            document.getElementById('tcrCount').textContent = 
                allStorms.filter(s => s.year >= 1995).length;
        }

        // Setup event listeners
        function setupEventListeners() {
            // Search input
            document.getElementById('searchInput').addEventListener('input', (e) => {
                activeFilters.search = e.target.value.toLowerCase();
                applyFilters();
            });

            // Filter chips
            document.querySelectorAll('.filter-chip').forEach(chip => {
                chip.addEventListener('click', (e) => {
                    const filter = e.target.dataset.filter;
                    const value = e.target.dataset.value;
                    
                    if (e.target.classList.contains('active')) {
                        e.target.classList.remove('active');
                        const index = activeFilters[filter].indexOf(value);
                        if (index > -1) activeFilters[filter].splice(index, 1);
                    } else {
                        e.target.classList.add('active');
                        if (!activeFilters[filter]) activeFilters[filter] = [];
                        activeFilters[filter].push(value);
                    }
                    
                    applyFilters();
                });
            });

            // Year inputs
            document.getElementById('yearStart').addEventListener('change', (e) => {
                activeFilters.yearStart = parseInt(e.target.value);
                applyFilters();
            });
            
            document.getElementById('yearEnd').addEventListener('change', (e) => {
                activeFilters.yearEnd = parseInt(e.target.value);
                applyFilters();
            });

            // Select all checkbox
            document.getElementById('selectAll').addEventListener('change', (e) => {
                const checkboxes = document.querySelectorAll('.storm-checkbox');
                checkboxes.forEach(cb => {
                    cb.checked = e.target.checked;
                    const stormId = cb.dataset.stormId;
                    if (e.target.checked) {
                        selectedStorms.add(stormId);
                    } else {
                        selectedStorms.delete(stormId);
                    }
                });
                updateSelectedCount();
            });
        }

        // Apply filters
        window.applyFilters = function() {
            filteredStorms = allStorms.filter(storm => {
                // Search filter
                if (activeFilters.search) {
                    const searchStr = `${storm.name} ${storm.year} ${storm.landfall_states?.join(' ')}`.toLowerCase();
                    if (!searchStr.includes(activeFilters.search)) return false;
                }

                // Year filter
                if (storm.year < activeFilters.yearStart || storm.year > activeFilters.yearEnd) return false;

                // Impact level filter
                if (activeFilters.impact?.length > 0) {
                    if (!activeFilters.impact.includes(storm.rc_impact_level)) return false;
                }

                // Category filter
                if (activeFilters.category?.length > 0) {
                    if (!activeFilters.category.includes(storm.category.toString())) return false;
                }

                // Special filters
                if (activeFilters.special?.includes('rc_response')) {
                    if (!storm.rc_response?.responded) return false;
                }
                if (activeFilters.special?.includes('has_tcr')) {
                    if (storm.year < 1995) return false; // TCRs mostly available post-1995
                }
                if (activeFilters.special?.includes('has_narrative')) {
                    if (!storm.narrative) return false;
                }
                if (activeFilters.special?.includes('high_quality')) {
                    if (storm.data_quality?.completeness_score < 80) return false;
                }
                if (activeFilters.special?.includes('exclude_td')) {
                    if (storm.category === -1) return false; // Exclude tropical depressions
                }
                if (activeFilters.special?.includes('us_landfall')) {
                    if (!storm.landfall_states || storm.landfall_states.length === 0) return false;
                }
                
                // State landfall filter
                if (activeFilters.state?.length > 0) {
                    if (!storm.landfall_states || storm.landfall_states.length === 0) return false;
                    // Check if storm made landfall in any of the selected states
                    const hasSelectedLandfall = storm.landfall_states.some(state => 
                        activeFilters.state.includes(state)
                    );
                    if (!hasSelectedLandfall) return false;
                }

                return true;
            });

            // Apply sorting after filtering
            sortData();
            
            currentPage = 1;
            renderTable();
            updateCounts();
        }
        
        // Sort table by column
        window.sortTable = function(column) {
            // If clicking the same column, toggle direction
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                // New column, default to descending for numeric, ascending for text
                sortColumn = column;
                sortDirection = ['year', 'category', 'rc_score', 'deaths', 'damage', 'quality'].includes(column) ? 'desc' : 'asc';
            }
            
            // Update sort indicators
            document.querySelectorAll('.sort-indicator').forEach(indicator => {
                indicator.textContent = '‚áÖ';
                indicator.classList.remove('active');
            });
            
            const indicator = document.getElementById(`sort-${column}`);
            if (indicator) {
                indicator.textContent = sortDirection === 'asc' ? '‚Üë' : '‚Üì';
                indicator.classList.add('active');
            }
            
            sortData();
            renderTable();
        }
        
        // Sort the filtered data
        function sortData() {
            filteredStorms.sort((a, b) => {
                let aVal, bVal;
                
                switch(sortColumn) {
                    case 'storm_id':
                        aVal = a.storm_id || '';
                        bVal = b.storm_id || '';
                        break;
                    case 'name':
                        aVal = a.name || '';
                        bVal = b.name || '';
                        break;
                    case 'year':
                        aVal = a.year;
                        bVal = b.year;
                        break;
                    case 'category':
                        aVal = a.category;
                        bVal = b.category;
                        break;
                    case 'impact':
                        const impactOrder = {'CATASTROPHIC': 5, 'SEVERE': 4, 'MAJOR': 3, 'MODERATE': 2, 'MINOR': 1};
                        aVal = impactOrder[a.rc_impact_level] || 0;
                        bVal = impactOrder[b.rc_impact_level] || 0;
                        break;
                    case 'rc_score':
                        aVal = a.rc_impact_score || 0;
                        bVal = b.rc_impact_score || 0;
                        break;
                    case 'states':
                        aVal = a.landfall_states?.length || 0;
                        bVal = b.landfall_states?.length || 0;
                        break;
                    case 'deaths':
                        aVal = a.deaths || 0;
                        bVal = b.deaths || 0;
                        break;
                    case 'damage':
                        aVal = a.damage_millions || 0;
                        bVal = b.damage_millions || 0;
                        break;
                    case 'quality':
                        aVal = a.data_quality?.completeness_score || 0;
                        bVal = b.data_quality?.completeness_score || 0;
                        break;
                    default:
                        return 0;
                }
                
                // Compare values
                if (aVal < bVal) return sortDirection === 'asc' ? -1 : 1;
                if (aVal > bVal) return sortDirection === 'asc' ? 1 : -1;
                return 0;
            });
        }

        // Render table
        function renderTable() {
            const tbody = document.getElementById('stormTableBody');
            tbody.innerHTML = '';

            const start = (currentPage - 1) * pageSize;
            const end = start + pageSize;
            const pageStorms = filteredStorms.slice(start, end);

            pageStorms.forEach(storm => {
                const row = document.createElement('tr');
                row.className = 'storm-row hover:bg-gray-50';
                row.setAttribute('data-storm-id', storm.storm_id);
                if (selectedStorms.has(storm.storm_id)) {
                    row.classList.add('storm-selected');
                }

                // Determine impact badge color
                let impactClass = 'impact-minor';
                if (storm.rc_impact_level === 'CATASTROPHIC') impactClass = 'impact-catastrophic';
                else if (storm.rc_impact_level === 'SEVERE') impactClass = 'impact-severe';
                else if (storm.rc_impact_level === 'MAJOR') impactClass = 'impact-major';
                else if (storm.rc_impact_level === 'MODERATE') impactClass = 'impact-moderate';

                row.innerHTML = `
                    <td class="px-4 py-3">
                        <input type="checkbox" class="storm-checkbox compare-checkbox" 
                               data-storm-id="${storm.storm_id}"
                               ${selectedStorms.has(storm.storm_id) ? 'checked' : ''}>
                    </td>
                    <td class="px-4 py-3 text-xs font-mono text-gray-600">${storm.storm_id}</td>
                    <td class="px-4 py-3 font-semibold">${storm.name}</td>
                    <td class="px-4 py-3">${storm.year}</td>
                    <td class="px-4 py-3">
                        <span class="px-2 py-1 text-xs font-bold rounded ${getCategoryClass(storm.category)}">
                            ${storm.category === -1 ? 'TD' : storm.category === 0 ? 'TS' : storm.category}
                        </span>
                    </td>
                    <td class="px-4 py-3">
                        <span class="px-2 py-1 text-xs text-white rounded ${impactClass}">
                            ${storm.rc_impact_level || 'N/A'}
                        </span>
                    </td>
                    <td class="px-4 py-3">
                        <div class="flex items-center">
                            <span class="font-bold ${getScoreColor(storm.rc_impact_score)}">${storm.rc_impact_score || 0}</span>
                            <div class="ml-2 w-12 bg-gray-200 rounded-full h-2">
                                <div class="h-2 rounded-full ${getScoreBarColor(storm.rc_impact_score)}" 
                                     style="width: ${storm.rc_impact_score || 0}%"></div>
                            </div>
                        </div>
                    </td>
                    <td class="px-4 py-3 text-xs">${storm.landfall_states?.join(', ') || '-'}</td>
                    <td class="px-4 py-3">${storm.deaths || 0}</td>
                    <td class="px-4 py-3">${storm.damage_millions ? '$' + storm.damage_millions.toLocaleString() + 'M' : '-'}</td>
                    <td class="px-4 py-3">
                        <div class="data-quality-bar w-16">
                            <div class="data-quality-fill ${getQualityColor(storm.data_quality?.completeness_score)}" 
                                 style="width: ${storm.data_quality?.completeness_score || 0}%"></div>
                        </div>
                        <span class="text-xs text-gray-600">${storm.data_quality?.completeness_score || 0}%</span>
                    </td>
                    <td class="px-4 py-3">
                        ${hasTCR(storm) ? 
                            '<span class="tcr-available">‚úì</span>' : 
                            '<span class="tcr-unavailable">‚úó</span>'}
                    </td>
                    <td class="px-4 py-3">
                        <div class="flex gap-1">
                            <button onclick="event.stopPropagation(); viewStorm('${storm.storm_id}'); return false;" 
                                    class="text-blue-600 hover:text-blue-800 text-xs">View</button>
                            <button onclick="event.stopPropagation(); trackStorm('${storm.storm_id}'); return false;" 
                                    class="text-orange-600 hover:text-orange-800 text-xs">Track</button>
                            ${hasTCR(storm) ? 
                                `<a href="${getTCRLink(storm)}" target="_blank" 
                                    class="text-green-600 hover:text-green-800 text-xs">TCR</a>` : ''}
                            ${storm.narrative ? 
                                `<button onclick="event.stopPropagation(); showNarrative('${storm.storm_id}'); return false;" 
                                         class="text-purple-600 hover:text-purple-800 text-xs">Story</button>` : ''}
                        </div>
                    </td>
                `;

                tbody.appendChild(row);
            });

            // Add checkbox listeners
            document.querySelectorAll('.storm-checkbox').forEach(cb => {
                cb.addEventListener('change', (e) => {
                    const stormId = e.target.dataset.stormId;
                    if (e.target.checked) {
                        selectedStorms.add(stormId);
                    } else {
                        selectedStorms.delete(stormId);
                    }
                    updateSelectedCount();
                });
            });
        }

        // Helper functions
        function getCategoryClass(category) {
            const classes = {
                '-1': 'bg-gray-200 text-gray-800',  // TD - Tropical Depression
                0: 'bg-blue-200 text-blue-800',      // TS - Tropical Storm
                1: 'bg-green-200 text-green-800',    // Category 1
                2: 'bg-yellow-200 text-yellow-800',  // Category 2
                3: 'bg-orange-200 text-orange-800',  // Category 3
                4: 'bg-red-200 text-red-800',        // Category 4
                5: 'bg-purple-200 text-purple-800'   // Category 5
            };
            return classes[category] || 'bg-gray-200 text-gray-800';
        }

        function getScoreColor(score) {
            if (score >= 80) return 'text-red-600';
            if (score >= 60) return 'text-orange-600';
            if (score >= 40) return 'text-yellow-600';
            return 'text-green-600';
        }

        function getScoreBarColor(score) {
            if (score >= 80) return 'bg-red-600';
            if (score >= 60) return 'bg-orange-600';
            if (score >= 40) return 'bg-yellow-600';
            return 'bg-green-600';
        }

        function getQualityColor(score) {
            if (score >= 80) return 'bg-green-500';
            if (score >= 60) return 'bg-yellow-500';
            if (score >= 40) return 'bg-orange-500';
            return 'bg-red-500';
        }

        function updateCounts() {
            document.getElementById('visibleCount').textContent = filteredStorms.length;
            document.getElementById('totalCount').textContent = allStorms.length;
            document.getElementById('totalPages').textContent = Math.ceil(filteredStorms.length / pageSize);
            document.getElementById('currentPage').textContent = currentPage;
        }

        function updateSelectedCount() {
            document.getElementById('selectedCount').textContent = selectedStorms.size;
            const compareBtn = document.getElementById('compareBtn');
            if (selectedStorms.size >= 2 && selectedStorms.size <= 3) {
                compareBtn.classList.remove('hidden');
            } else {
                compareBtn.classList.add('hidden');
            }
        }

        // Actions
        window.compareSelected = function() {
            console.log('compareSelected called, selected storms:', selectedStorms.size);
            if (selectedStorms.size === 0) {
                alert('Please select at least one storm to compare.');
                return;
            }
            if (selectedStorms.size > 3) {
                alert('You can compare up to 3 storms at a time. Please deselect some storms.');
                return;
            }
            
            const ids = Array.from(selectedStorms).join(',');
            console.log('Sending storm IDs to compare:', ids);
            window.parent.postMessage({
                action: 'compareStorms',
                stormIds: ids
            }, '*');
        }

        window.exportSelected = function() {
            const storms = selectedStorms.size > 0 ? 
                filteredStorms.filter(s => selectedStorms.has(s.storm_id)) : 
                filteredStorms;
            
            const csv = convertToCSV(storms);
            const timestamp = new Date().toISOString().split('T')[0];
            const filename = `hurricane_data_${timestamp}_${storms.length}_storms.csv`;
            downloadCSV(csv, filename);
        }

        function convertToCSV(storms) {
            // Comprehensive export with ALL available fields
            const headers = [
                'Storm ID', 'Name', 'Year', 'Month', 'Day', 'Category', 
                'Wind (mph)', 'Wind (knots)', 'Pressure (mb)', 'ACE Index',
                'Latitude', 'Longitude', 'Landfall States', 'Deaths',
                'RC Impact Level', 'RC Impact Score', 'RC Response', 'RC Operation Type',
                'Est. Shelters', 'Est. Meals', 'Est. Volunteers',
                'Has Narrative', 'Has Track Data', 'Has TCR', 'Data Quality Score',
                'TCR PDF Link', 'Best Track Link', 'Narrative'
            ];
            
            // Helper to escape CSV fields
            const escapeCSV = (field) => {
                if (field === null || field === undefined) return '';
                const str = String(field);
                if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                    return '"' + str.replace(/"/g, '""') + '"';
                }
                return str;
            };
            
            const rows = storms.map(s => [
                s.storm_id,
                escapeCSV(s.name),
                s.year,
                s.month,
                s.day,
                s.category,
                s.wind_mph || '',
                s.wind_knots || '',
                s.pressure || '',
                s.ace || '',
                s.lat || '',
                s.lon || '',
                escapeCSV(s.landfall_states?.join('; ') || ''),
                s.deaths || 0,
                escapeCSV(s.rc_impact_level || ''),
                s.rc_impact_score || 0,
                s.rc_response?.responded ? 'Yes' : 'No',
                escapeCSV(s.rc_response?.operation_type || ''),
                s.rc_response?.estimated_shelters || '',
                s.rc_response?.estimated_meals || '',
                s.rc_response?.estimated_volunteers || '',
                s.data_quality?.has_narrative ? 'Yes' : 'No',
                s.data_quality?.has_track_data ? 'Yes' : 'No',
                hasTCR(s) ? 'Yes' : 'No',
                s.data_quality?.completeness_score || 0,
                escapeCSV(s.resources?.tcr_pdf || ''),
                escapeCSV(s.resources?.best_track || ''),
                escapeCSV(s.narrative || '')
            ]);
            
            return [headers.map(escapeCSV), ...rows.map(row => row.map(escapeCSV))].map(row => row.join(',')).join('\n');
        }

        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
        }

        window.viewStorm = function(stormId) {
            console.log('viewStorm called with ID:', stormId);
            // Prevent any bubbling or default behavior
            if (window.event) {
                window.event.stopPropagation();
                window.event.preventDefault();
            }
            // Just call trackStorm to show the animation modal
            trackStorm(stormId);
        }
        
        window.trackStorm = function(stormId) {
            console.log('trackStorm called with ID:', stormId);
            // Prevent any bubbling or default behavior
            if (window.event) {
                window.event.stopPropagation();
                window.event.preventDefault();
            }
            const storm = allStorms.find(s => s.storm_id === stormId);
            if (storm) {
                // Create a simple modal using a more straightforward approach
                const modalHTML = `
                    <div id="trackModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); display: flex; align-items: center; justify-content: center; z-index: 9999;">
                        <div style="background-color: white; padding: 30px; border-radius: 10px; width: 90%; max-width: 900px; max-height: 90vh; overflow-y: auto; position: relative; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
                            <button onclick="if(window.trackMap){window.trackMap.remove();window.trackMap=null;}document.getElementById('trackModal').remove()" style="position: absolute; top: 10px; right: 10px; background-color: #ED1B2E; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-size: 16px; font-weight: bold;">‚úï</button>
                            
                            <h2 style="margin: 0 0 20px 0; color: #ED1B2E; font-size: 24px; font-weight: bold;">
                                üéØ Tracking ${storm.name} (${storm.year})
                            </h2>
                            
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                                <h3 style="margin: 0 0 10px 0; color: #003d79; font-size: 18px; font-weight: bold;">Storm Details</h3>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                    <div><strong>Category:</strong> ${storm.category === -1 ? 'TD' : storm.category === 0 ? 'TS' : 'Cat ' + storm.category}</div>
                                    <div><strong>Wind Speed:</strong> ${storm.wind_mph || 0} mph</div>
                                    <div><strong>Date:</strong> ${getMonthName(storm.month)} ${storm.day}, ${storm.year}</div>
                                    <div><strong>Deaths:</strong> ${storm.deaths || 0}</div>
                                    <div><strong>Landfall States:</strong> ${storm.landfall_states?.join(', ') || 'None'}</div>
                                    <div><strong>RC Impact:</strong> ${storm.rc_impact_score || 0}/100</div>
                                </div>
                            </div>
                            
                            <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                                <h3 style="margin: 0 0 10px 0; color: #4caf50; font-size: 18px; font-weight: bold;">üó∫Ô∏è Storm Track Animation</h3>
                                <div id="trackMapContainer" style="height: 400px; width: 100%; border: 2px solid #ddd; border-radius: 8px; margin: 10px 0; position: relative;">
                                    <div id="trackMap" style="height: 100%; width: 100%;"></div>
                                </div>
                                <div style="margin-top: 10px;">
                                    <button onclick="animateTrack('${storm.storm_id}')" style="padding: 8px 16px; background-color: #4caf50; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; margin-right: 10px;">
                                        ‚ñ∂Ô∏è Animate Track
                                    </button>
                                    <button onclick="stopTrackAnimation()" style="padding: 8px 16px; background-color: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">
                                        ‚èπÔ∏è Stop
                                    </button>
                                    <label style="margin-left: 20px;">Speed: <input type="range" id="trackAnimationSpeed" min="100" max="2000" value="1000" style="width: 100px; vertical-align: middle;"></label>
                                </div>
                            </div>
                            
                            ${storm.narrative ? `
                                <div style="background: #f5f5f5; padding: 15px; border-radius: 8px;">
                                    <h3 style="margin: 0 0 10px 0; color: #666; font-size: 18px; font-weight: bold;">üìñ Storm Narrative</h3>
                                    <p style="line-height: 1.6; color: #333; margin: 0;">${storm.narrative}</p>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
                
                // Insert the modal into the page
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                
                // Add click outside to close
                const modal = document.getElementById('trackModal');
                if (modal) {
                    modal.onclick = function(e) {
                        if (e.target === modal) {
                            modal.remove();
                            if (window.trackMap) {
                                window.trackMap.remove();
                                window.trackMap = null;
                            }
                        }
                    };
                }
                
                // Initialize the map after modal is inserted
                setTimeout(() => {
                    initializeTrackMap(storm);
                }, 100);
            }
        }
        
        // Global variables for track animation
        let trackMap = null;
        let animationInterval = null;
        let currentTrackData = null;
        let animationMarker = null;
        let trailPolyline = null;
        
        // Initialize map for track animation
        window.initializeTrackMap = function(storm) {
            const mapContainer = document.getElementById('trackMap');
            if (!mapContainer || trackMap) return;
            
            // Create map
            trackMap = L.map('trackMap').setView([25, -80], 5);
            
            // Add tile layer
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(trackMap);
            
            // Load and display storm track
            loadStormTrackForAnimation(storm);
        }
        
        // Load storm track data
        window.loadStormTrackForAnimation = async function(storm) {
            try {
                const decade = Math.floor(storm.year / 10) * 10;
                const pointsFile = `./hurdat2_data/points_${decade}s.geojson`;
                
                const response = await fetch(pointsFile);
                if (response.ok) {
                    const data = await response.json();
                    const features = data.features.filter(f => f.properties.storm_id === storm.storm_id);
                    
                    if (features.length > 0) {
                        currentTrackData = features;
                        displayStaticTrack(features);
                    } else {
                        // Try tracks file as fallback
                        const tracksFile = `./hurdat2_data/tracks_${decade}s.geojson`;
                        const tracksResponse = await fetch(tracksFile);
                        if (tracksResponse.ok) {
                            const tracksData = await tracksResponse.json();
                            const trackFeature = tracksData.features.find(f => f.properties.storm_id === storm.storm_id);
                            if (trackFeature) {
                                displaySimpleTrack(trackFeature);
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading track data:', error);
            }
        }
        
        // Display static track
        window.displayStaticTrack = function(features) {
            if (!trackMap) return;
            
            // Sort by datetime
            features.sort((a, b) => new Date(a.properties.datetime) - new Date(b.properties.datetime));
            
            // Create points and bounds
            const points = [];
            const bounds = L.latLngBounds();
            
            features.forEach(feature => {
                const coords = feature.geometry.coordinates;
                const lat = coords[1];
                const lon = coords[0];
                const point = [lat, lon];
                points.push(point);
                bounds.extend(point);
                
                // Add circle marker for each point
                const cat = feature.properties.ss || feature.properties.category || 0;
                const color = getCategoryColorForMap(cat);
                L.circleMarker(point, {
                    radius: 4,
                    fillColor: color,
                    color: 'white',
                    weight: 1,
                    opacity: 1,
                    fillOpacity: 0.8
                }).addTo(trackMap);
            });
            
            // Draw track line
            if (points.length > 1) {
                L.polyline(points, {
                    color: '#666',
                    weight: 2,
                    opacity: 0.6
                }).addTo(trackMap);
            }
            
            // Fit map to track
            trackMap.fitBounds(bounds.pad(0.1));
        }
        
        // Display simple track
        window.displaySimpleTrack = function(trackFeature) {
            if (!trackMap || !trackFeature.geometry.coordinates) return;
            
            const coords = trackFeature.geometry.coordinates;
            const points = coords.map(coord => [coord[1], coord[0]]);
            
            // Draw track line
            L.polyline(points, {
                color: '#ff0000',
                weight: 3,
                opacity: 0.8
            }).addTo(trackMap);
            
            // Add start and end markers
            if (points.length > 0) {
                L.marker(points[0]).addTo(trackMap).bindPopup('Start');
                L.marker(points[points.length - 1]).addTo(trackMap).bindPopup('End');
                
                // Fit map to track
                const bounds = L.latLngBounds(points);
                trackMap.fitBounds(bounds.pad(0.1));
            }
        }
        
        // Animate track
        window.animateTrack = function(stormId) {
            if (!currentTrackData || currentTrackData.length === 0) {
                alert('No track data available for animation');
                return;
            }
            
            // Clear any existing animation
            stopTrackAnimation();
            
            // Create animated marker
            animationMarker = L.marker([0, 0], {
                icon: L.divIcon({
                    className: 'animation-marker',
                    html: '<div style="background: red; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 4px rgba(0,0,0,0.5);"></div>',
                    iconSize: [16, 16]
                })
            }).addTo(trackMap);
            
            // Create trail polyline  
            trailPolyline = L.polyline([], {
                color: '#666',
                weight: 3,
                opacity: 0.8
            }).addTo(trackMap);
            
            // We'll draw colored segments as we go
            const trailSegments = [];
            
            // Start animation
            let index = 0;
            const speed = document.getElementById('trackAnimationSpeed').value;
            
            animationInterval = setInterval(() => {
                if (index >= currentTrackData.length) {
                    stopTrackAnimation();
                    return;
                }
                
                const feature = currentTrackData[index];
                const coords = feature.geometry.coordinates;
                const lat = coords[1];
                const lon = coords[0];
                
                // Update marker position
                animationMarker.setLatLng([lat, lon]);
                
                // Update marker color based on intensity
                const markerCat = feature.properties.ss || feature.properties.category || 0;
                const markerColor = getCategoryColorForMap(markerCat);
                animationMarker.setIcon(L.divIcon({
                    className: 'animation-marker',
                    html: `<div style="background: ${markerColor}; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 4px rgba(0,0,0,0.5);"></div>`,
                    iconSize: [16, 16]
                }));
                
                // Add to trail
                const trail = trailPolyline.getLatLngs();
                trail.push([lat, lon]);
                trailPolyline.setLatLngs(trail);
                
                // Update popup
                // Debug: log first feature to see available properties
                if (index === 0) {
                    console.log('Storm track feature properties:', feature.properties);
                }
                
                const datetime = new Date(feature.properties.datetime).toLocaleString();
                const category = feature.properties.ss || feature.properties.category || 'Unknown';
                const wind = feature.properties.wind || feature.properties.wind_mph || 'N/A';
                
                // Format category display
                let categoryDisplay = category;
                if (category === -1) categoryDisplay = 'TD';
                else if (category === 0) categoryDisplay = 'TS';
                else if (category > 0) categoryDisplay = `Cat ${category}`;
                
                animationMarker.bindPopup(`
                    <strong>${datetime}</strong><br>
                    Category: ${categoryDisplay}<br>
                    Wind: ${wind} mph
                `).openPopup();
                
                index++;
            }, speed);
        }
        
        // Stop animation
        window.stopTrackAnimation = function() {
            if (animationInterval) {
                clearInterval(animationInterval);
                animationInterval = null;
            }
            if (animationMarker) {
                trackMap.removeLayer(animationMarker);
                animationMarker = null;
            }
            if (trailPolyline) {
                trackMap.removeLayer(trailPolyline);
                trailPolyline = null;
            }
        }
        
        // Get category color for map
        window.getCategoryColorForMap = function(category) {
            const colors = {
                '-1': '#94a3b8', // TD - Slate
                '0': '#3b82f6',  // TS - Blue
                '1': '#10b981',  // Cat 1 - Green
                '2': '#f59e0b',  // Cat 2 - Yellow/Amber
                '3': '#f97316',  // Cat 3 - Orange
                '4': '#ef4444',  // Cat 4 - Red
                '5': '#7c3aed'   // Cat 5 - Purple
            };
            return colors[category] || '#6b7280';
        }

        window.showNarrative = function(stormId) {
            const storm = allStorms.find(s => s.storm_id === stormId);
            if (storm?.narrative) {
                // Create a simple modal using the same approach as trackStorm
                const modalHTML = `
                    <div id="narrativeModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 9999;">
                        <div style="background-color: white; padding: 30px; border-radius: 10px; max-width: 600px; max-height: 80vh; overflow-y: auto; position: relative; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
                            <button onclick="document.getElementById('narrativeModal').remove()" style="position: absolute; top: 10px; right: 10px; background-color: #ED1B2E; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-size: 16px;">‚úï</button>
                            <h2 style="margin: 0 0 20px 0; color: #ED1B2E;">${storm.name} (${storm.year})</h2>
                            <p style="line-height: 1.6; color: #333;">${storm.narrative}</p>
                        </div>
                    </div>
                `;
                
                // Insert the modal into the page
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                
                // Add click outside to close
                const modal = document.getElementById('narrativeModal');
                if (modal) {
                    modal.onclick = function(e) {
                        if (e.target === modal) {
                            modal.remove();
                        }
                    };
                }
            }
        }

        window.clearFilters = function() {
            activeFilters = {
                search: '',
                impact: [],
                category: [],
                special: [],
                state: [],
                yearStart: 1851,
                yearEnd: 2024
            };
            document.getElementById('searchInput').value = '';
            document.getElementById('yearStart').value = 1851;
            document.getElementById('yearEnd').value = 2024;
            document.querySelectorAll('.filter-chip').forEach(chip => {
                chip.classList.remove('active');
            });
            applyFilters();
        }

        window.changePageSize = function() {
            pageSize = parseInt(document.getElementById('pageSize').value);
            currentPage = 1;
            renderTable();
            updateCounts();
        }

        window.previousPage = function() {
            if (currentPage > 1) {
                currentPage--;
                renderTable();
                updateCounts();
            }
        }

        window.nextPage = function() {
            const totalPages = Math.ceil(filteredStorms.length / pageSize);
            if (currentPage < totalPages) {
                currentPage++;
                renderTable();
                updateCounts();
            }
        }

        window.viewOnMap = function() {
            console.log('viewOnMap called');
            // Send selected storms to map view
            const storms = selectedStorms.size > 0 ? 
                filteredStorms.filter(s => selectedStorms.has(s.storm_id)) : 
                filteredStorms.slice(0, 100); // Limit to 100 for performance
            
            console.log('Sending', storms.length, 'storms to parent');
            window.parent.postMessage({
                action: 'viewOnMap',
                storms: storms
            }, '*');
        }
        
        // Check if a storm has a TCR report available
        window.hasTCR = function(storm) {
            // TCRs are generally available for storms after 1995
            // and for significant storms (Cat 3+ or major impact)
            return storm.year >= 1995 && (storm.category >= 3 || storm.rc_impact_level === 'CATASTROPHIC' || storm.rc_impact_level === 'SEVERE');
        }
        
        // Get the TCR link for a storm
        window.getTCRLink = function(storm) {
            // Construct NOAA TCR URL
            // Format: https://www.nhc.noaa.gov/data/tcr/AL##YYYY_Name.pdf
            const stormNumber = storm.storm_id.substring(2, 4); // Extract storm number from ID
            const baseUrl = 'https://www.nhc.noaa.gov/data/tcr/';
            const filename = `AL${stormNumber}${storm.year}_${storm.name}.pdf`;
            return baseUrl + filename;
        }
        
        // Override parent postMessage to debug
        const originalPostMessage = window.parent.postMessage;
        window.parent.postMessage = function(data, origin) {
            console.log('Database sending message to parent:', data);
            originalPostMessage.call(window.parent, data, origin);
        };
        
        // Listen for AI Assistant filter messages
        window.addEventListener('message', function(event) {
            if (event.data && event.data.action === 'applyFilters') {
                console.log('Database: Applying AI-suggested filters:', event.data.filters);
                const filters = event.data.filters;
                
                // Apply year filters
                if (filters.yearStart !== undefined) {
                    document.getElementById('yearStart').value = filters.yearStart;
                }
                if (filters.yearEnd !== undefined) {
                    document.getElementById('yearEnd').value = filters.yearEnd;
                }
                
                // Apply category filters
                if (filters.categories) {
                    // Clear all category checkboxes first
                    document.querySelectorAll('input[id^="cat"]').forEach(cb => cb.checked = false);
                    // Check the requested categories
                    filters.categories.forEach(cat => {
                        const catId = cat === '-1' ? 'catTD' : `cat${cat}`;
                        const checkbox = document.getElementById(catId);
                        if (checkbox) checkbox.checked = true;
                    });
                } else if (filters.category !== undefined) {
                    // Clear all and check only the specified category
                    document.querySelectorAll('input[id^="cat"]').forEach(cb => cb.checked = false);
                    const catId = filters.category === -1 ? 'catTD' : `cat${filters.category}`;
                    const checkbox = document.getElementById(catId);
                    if (checkbox) checkbox.checked = true;
                }
                
                // Apply search filter
                if (filters.search) {
                    document.getElementById('searchInput').value = filters.search;
                }
                
                // Apply landfall state filter if provided
                if (filters.landfallState) {
                    const stateSelect = document.getElementById('stateFilter');
                    if (stateSelect) {
                        stateSelect.value = filters.landfallState;
                    }
                }
                
                // Trigger the filter update
                filterStorms();
            }
        });
        
        // Storm Comparison Functions
        window.showComparison = function() {
            if (selectedStorms.size < 2 || selectedStorms.size > 3) {
                alert('Please select 2-3 storms to compare');
                return;
            }
            
            const modal = document.getElementById('comparisonModal');
            const content = document.getElementById('comparisonContent');
            
            // Get selected storm data
            const storms = Array.from(selectedStorms).map(id => 
                allStorms.find(s => s.storm_id === id)
            ).filter(s => s);
            
            // Build comparison table
            let html = `
                <div class="overflow-x-auto">
                    <table class="min-w-full">
                        <thead>
                            <tr class="border-b-2 border-gray-300">
                                <th class="px-4 py-2 text-left text-gray-700">Attribute</th>
                                ${storms.map(s => `<th class="px-4 py-2 text-left">${s.name} (${s.year})</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="border-b">
                                <td class="px-4 py-3 font-semibold">Category</td>
                                ${storms.map(s => `<td class="px-4 py-3"><span class="px-2 py-1 text-xs font-bold rounded ${getCategoryClass(s.category)}">${s.category === -1 ? 'TD' : s.category === 0 ? 'TS' : 'Cat ' + s.category}</span></td>`).join('')}
                            </tr>
                            <tr class="border-b bg-gray-50">
                                <td class="px-4 py-3 font-semibold">Wind Speed</td>
                                ${storms.map(s => `<td class="px-4 py-3">${s.wind_mph || 0} mph</td>`).join('')}
                            </tr>
                            <tr class="border-b">
                                <td class="px-4 py-3 font-semibold">RC Impact Score</td>
                                ${storms.map(s => `<td class="px-4 py-3"><div class="flex items-center"><span class="font-bold ${getScoreColor(s.rc_impact_score)}">${s.rc_impact_score || 0}</span><div class="ml-2 w-16 bg-gray-200 rounded-full h-2"><div class="h-2 rounded-full ${getScoreBarColor(s.rc_impact_score)}" style="width: ${s.rc_impact_score || 0}%"></div></div></div></td>`).join('')}
                            </tr>
                            <tr class="border-b bg-gray-50">
                                <td class="px-4 py-3 font-semibold">Deaths</td>
                                ${storms.map(s => `<td class="px-4 py-3 ${s.deaths > 100 ? 'text-red-600 font-bold' : ''}">${s.deaths || 0}</td>`).join('')}
                            </tr>
                            <tr class="border-b">
                                <td class="px-4 py-3 font-semibold">Damage</td>
                                ${storms.map(s => `<td class="px-4 py-3">${s.damage_millions ? '$' + s.damage_millions.toLocaleString() + 'M' : '-'}</td>`).join('')}
                            </tr>
                            <tr class="border-b bg-gray-50">
                                <td class="px-4 py-3 font-semibold">Landfall States</td>
                                ${storms.map(s => `<td class="px-4 py-3">${s.landfall_states?.join(', ') || '-'}</td>`).join('')}
                            </tr>
                            <tr class="border-b">
                                <td class="px-4 py-3 font-semibold">Date</td>
                                ${storms.map(s => `<td class="px-4 py-3">${getMonthName(s.month)} ${s.day}, ${s.year}</td>`).join('')}
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="mt-6 grid grid-cols-${storms.length} gap-6">
                    ${storms.map(s => `
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h3 class="font-bold text-lg mb-2">${s.name} Narrative</h3>
                            <p class="text-sm text-gray-700 leading-relaxed">${s.narrative || 'No narrative available'}</p>
                        </div>
                    `).join('')}
                </div>
            `;
            
            content.innerHTML = html;
            modal.classList.remove('hidden');
        }
        
        window.closeComparison = function() {
            document.getElementById('comparisonModal').classList.add('hidden');
        }
        
        function getMonthName(month) {
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            return months[month - 1] || '';
        }
    </script>
    
    <!-- Storm Comparison Modal -->
    <div id="comparisonModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg max-w-6xl w-full max-h-[90vh] overflow-y-auto">
                <div class="sticky top-0 bg-white border-b px-6 py-4 flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-gray-900">Storm Comparison</h2>
                    <button onclick="closeComparison()" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div id="comparisonContent" class="p-6">
                    <!-- Comparison content will be populated here -->
                </div>
            </div>
        </div>
    </div>
</body>
</html>