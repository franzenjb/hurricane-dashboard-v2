<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Red Cross Response Operations</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="atlantic-storms-enhanced.js"></script>
    <style>
        .operation-card { 
            transition: all 0.3s ease; 
            border-left: 4px solid transparent;
        }
        .operation-card:hover { 
            transform: translateX(5px); 
            border-left-color: #ED1B2E;
        }
        .stat-card {
            background: linear-gradient(135deg, #ffffff 0%, #f9fafb 100%);
            border: 1px solid #e5e7eb;
        }
        .level-3 { border-left: 4px solid #7f1d1d; }
        .level-2 { border-left: 4px solid #dc2626; }
        .level-1 { border-left: 4px solid #f59e0b; }
        #responseMap { height: 400px; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- DISCLAIMER BANNER -->
    <div class="bg-yellow-100 border-b-2 border-yellow-500">
        <div class="max-w-7xl mx-auto px-4 py-3">
            <div class="flex items-center gap-2">
                <svg class="w-6 h-6 text-yellow-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                </svg>
                <div>
                    <p class="text-sm font-semibold text-yellow-800">DEMONSTRATION PROTOTYPE - FICTIONAL DATA</p>
                    <p class="text-xs text-yellow-700">This Response tab contains simulated data for demonstration purposes only. Actual Red Cross response data is not yet integrated. This feature is under development.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <div class="bg-white shadow-md border-b-4 border-red-600">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 rounded-full bg-red-600 flex items-center justify-center text-white font-bold text-xl">RC</div>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">Red Cross Response Operations</h1>
                        <p class="text-sm text-gray-600">Historical Hurricane Response Data & Analytics</p>
                    </div>
                </div>
                <div class="text-right">
                    <div class="text-3xl font-bold text-red-600" id="totalOperations">0</div>
                    <div class="text-xs text-gray-600">TOTAL OPERATIONS</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Key Statistics -->
    <div class="max-w-7xl mx-auto px-4 py-6">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
            <div class="stat-card p-4 rounded-lg">
                <div class="text-3xl font-bold text-gray-900" id="totalShelters">0</div>
                <div class="text-xs text-gray-600 uppercase">Emergency Shelters</div>
                <div class="text-sm text-green-600 mt-1">↑ 12% vs 10yr avg</div>
            </div>
            <div class="stat-card p-4 rounded-lg">
                <div class="text-3xl font-bold text-gray-900" id="totalMeals">0</div>
                <div class="text-xs text-gray-600 uppercase">Meals Served</div>
                <div class="text-sm text-green-600 mt-1">↑ 8% vs 10yr avg</div>
            </div>
            <div class="stat-card p-4 rounded-lg">
                <div class="text-3xl font-bold text-gray-900" id="totalVolunteers">0</div>
                <div class="text-xs text-gray-600 uppercase">Volunteers Deployed</div>
                <div class="text-sm text-red-600 mt-1">↓ 3% vs 10yr avg</div>
            </div>
            <div class="stat-card p-4 rounded-lg">
                <div class="text-3xl font-bold text-gray-900" id="totalFamilies">0</div>
                <div class="text-xs text-gray-600 uppercase">Families Helped</div>
                <div class="text-sm text-green-600 mt-1">↑ 15% vs 10yr avg</div>
            </div>
            <div class="stat-card p-4 rounded-lg">
                <div class="text-3xl font-bold text-gray-900" id="totalCost">$0M</div>
                <div class="text-xs text-gray-600 uppercase">Response Cost</div>
                <div class="text-sm text-green-600 mt-1">↑ 22% vs 10yr avg</div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 pb-6">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <!-- Left Column - Operations List -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-lg shadow-md p-4">
                    <h2 class="text-lg font-bold mb-4">Major Operations (2000-2024)</h2>
                    
                    <!-- Filter -->
                    <div class="mb-4">
                        <select id="operationFilter" class="w-full px-3 py-2 border rounded-lg text-sm">
                            <option value="all">All Operations</option>
                            <option value="3">Level 3 - Catastrophic</option>
                            <option value="2">Level 2 - Major</option>
                            <option value="1">Level 1 - Moderate</option>
                        </select>
                    </div>
                    
                    <!-- Operations List -->
                    <div id="operationsList" class="space-y-2 max-h-96 overflow-y-auto">
                        <!-- Operations will be populated here -->
                    </div>
                </div>

                <!-- Resources by Year Chart -->
                <div class="bg-white rounded-lg shadow-md p-4 mt-4">
                    <h3 class="text-lg font-bold mb-4">Resources Deployed by Year</h3>
                    <div id="resourcesChart" style="height: 350px;"></div>
                </div>
            </div>

            <!-- Center Column - Map & Details -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-lg shadow-md p-4">
                    <h2 class="text-lg font-bold mb-4">Response Operations Map</h2>
                    <div id="responseMap" class="rounded-lg"></div>
                </div>

                <!-- Selected Operation Details -->
                <div id="operationDetails" class="bg-white rounded-lg shadow-md p-4 mt-4" style="display: none;">
                    <h3 class="text-lg font-bold mb-4">Operation Details</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <h4 class="text-2xl font-bold" id="detailName">-</h4>
                            <p class="text-gray-600" id="detailDate">-</p>
                        </div>
                        <div class="text-right">
                            <span id="detailLevel" class="px-3 py-1 rounded-full text-white text-sm font-bold">-</span>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-6">
                        <div class="text-center p-3 bg-gray-50 rounded">
                            <div class="text-2xl font-bold text-red-600" id="detailShelters">-</div>
                            <div class="text-xs text-gray-600">SHELTERS</div>
                        </div>
                        <div class="text-center p-3 bg-gray-50 rounded">
                            <div class="text-2xl font-bold text-red-600" id="detailMeals">-</div>
                            <div class="text-xs text-gray-600">MEALS</div>
                        </div>
                        <div class="text-center p-3 bg-gray-50 rounded">
                            <div class="text-2xl font-bold text-red-600" id="detailVolunteers">-</div>
                            <div class="text-xs text-gray-600">VOLUNTEERS</div>
                        </div>
                        <div class="text-center p-3 bg-gray-50 rounded">
                            <div class="text-2xl font-bold text-red-600" id="detailCost">-</div>
                            <div class="text-xs text-gray-600">COST</div>
                        </div>
                    </div>
                    
                    <div class="mt-6">
                        <h4 class="font-bold mb-2">Affected States</h4>
                        <div id="detailStates" class="flex flex-wrap gap-2">-</div>
                    </div>
                    
                    <div class="mt-4">
                        <h4 class="font-bold mb-2">Response Timeline</h4>
                        <div class="text-sm text-gray-600" id="detailTimeline">
                            Response operations typically begin 24-48 hours before landfall...
                        </div>
                    </div>
                </div>

                <!-- Response Patterns -->
                <div class="bg-white rounded-lg shadow-md p-4 mt-4">
                    <h3 class="text-lg font-bold mb-4">Response Patterns & Insights</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="p-4 bg-blue-50 rounded-lg">
                            <h4 class="font-bold text-blue-900">Peak Season</h4>
                            <p class="text-sm text-blue-700 mt-2">
                                80% of operations occur Aug-Oct, with September averaging 3.2 major responses
                            </p>
                        </div>
                        <div class="p-4 bg-green-50 rounded-lg">
                            <h4 class="font-bold text-green-900">Resource Efficiency</h4>
                            <p class="text-sm text-green-700 mt-2">
                                Digital volunteer coordination has improved efficiency by 35% since 2015
                            </p>
                        </div>
                        <div class="p-4 bg-yellow-50 rounded-lg">
                            <h4 class="font-bold text-yellow-900">Response Time</h4>
                            <p class="text-sm text-yellow-700 mt-2">
                                Average mobilization: 36 hours pre-landfall, 12 hours for emergency shelters
                            </p>
                        </div>
                        <div class="p-4 bg-purple-50 rounded-lg">
                            <h4 class="font-bold text-purple-900">Cost Trends</h4>
                            <p class="text-sm text-purple-700 mt-2">
                                Response costs have increased 180% since 2000, driven by storm intensity
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize data
        const allStorms = ATLANTIC_STORMS_ENHANCED;
        let responseMap;
        let selectedOperation = null;
        
        // Filter major storms (Cat 3+) with RC response AND US landfall
        const rcOperations = allStorms
            .filter(s => s.year >= 2000 && 
                        s.category >= 3 &&  // Only Cat 3, 4, and 5 storms
                        s.rc_response?.responded && 
                        s.landfall_states && 
                        s.landfall_states.length > 0)
            .sort((a, b) => b.year - a.year || b.rc_impact_score - a.rc_impact_score);

        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            initializeMap();
            populateOperationsList();
            updateStatistics();
            createResourcesChart();
            setupEventListeners();
        });

        let currentStormLayer = null;
        
        function initializeMap() {
            responseMap = L.map('responseMap').setView([28.0, -80.0], 5);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(responseMap);
            
            // Focus on US Atlantic coastline - no markers initially
            // Storm tracks will be added when operations are selected
        }

        function populateOperationsList() {
            const list = document.getElementById('operationsList');
            list.innerHTML = '';
            
            rcOperations.forEach(op => {
                const div = document.createElement('div');
                div.className = `operation-card p-3 bg-white border rounded-lg cursor-pointer hover:bg-gray-50 ${op.rc_response.operation_type === 'Level 3' ? 'level-3' : op.rc_response.operation_type === 'Level 2' ? 'level-2' : 'level-1'}`;
                div.onclick = () => selectOperation(op);
                
                div.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-bold">${op.name} (${op.year})</h4>
                            <p class="text-sm text-gray-600">Category ${op.category} • ${op.rc_response.operation_type}</p>
                        </div>
                        <div class="text-right">
                            <div class="text-lg font-bold text-red-600">${op.rc_impact_score}</div>
                            <div class="text-xs text-gray-500">SCORE</div>
                        </div>
                    </div>
                `;
                
                list.appendChild(div);
            });
        }

        function selectOperation(op) {
            selectedOperation = op;
            
            // Update details panel
            document.getElementById('operationDetails').style.display = 'block';
            document.getElementById('detailName').textContent = `${op.name} (${op.year})`;
            document.getElementById('detailDate').textContent = `${getMonthName(op.month)} ${op.day}, ${op.year}`;
            
            const levelSpan = document.getElementById('detailLevel');
            levelSpan.textContent = op.rc_response.operation_type;
            levelSpan.className = op.rc_response.operation_type === 'Level 3' ? 
                'px-3 py-1 rounded-full text-white text-sm font-bold bg-red-900' :
                op.rc_response.operation_type === 'Level 2' ? 
                'px-3 py-1 rounded-full text-white text-sm font-bold bg-red-600' :
                'px-3 py-1 rounded-full text-white text-sm font-bold bg-yellow-600';
            
            // Update stats (with estimates)
            const shelters = op.rc_response.actual_shelters || op.rc_response.estimated_shelters || Math.round(15 + op.rc_impact_score / 2);
            const meals = op.rc_response.actual_meals || op.rc_response.estimated_meals || Math.round(50000 + op.rc_impact_score * 1000);
            const volunteers = op.rc_response.actual_volunteers || op.rc_response.estimated_volunteers || Math.round(200 + op.rc_impact_score * 5);
            const cost = op.rc_response.actual_cost || Math.round(2 + op.rc_impact_score / 10);
            
            document.getElementById('detailShelters').textContent = shelters;
            document.getElementById('detailMeals').textContent = (meals / 1000).toFixed(0) + 'K';
            document.getElementById('detailVolunteers').textContent = volunteers.toLocaleString();
            document.getElementById('detailCost').textContent = '$' + cost + 'M';
            
            // Update states
            const statesDiv = document.getElementById('detailStates');
            statesDiv.innerHTML = '';
            if (op.landfall_states && op.landfall_states.length > 0) {
                op.landfall_states.forEach(state => {
                    const span = document.createElement('span');
                    span.className = 'px-3 py-1 bg-red-100 text-red-800 rounded-full text-sm';
                    span.textContent = state;
                    statesDiv.appendChild(span);
                });
            }
            
            // Load and display storm track
            loadStormTrack(op);
        }

        async function loadStormTrack(storm) {
            // Clear previous track
            if (currentStormLayer) {
                responseMap.removeLayer(currentStormLayer);
                currentStormLayer = null;
            }
            
            if (!storm.storm_id) return;
            
            // Calculate decade for file path
            const decade = Math.floor(storm.year / 10) * 10;
            const pointsFile = `hurdat2_data/points_${decade}s.geojson`;
            
            try {
                const response = await fetch(pointsFile);
                if (response.ok) {
                    const data = await response.json();
                    const stormPoints = data.features.filter(f => 
                        f.properties.storm_id === storm.storm_id
                    );
                    
                    if (stormPoints.length > 0) {
                        drawStormTrack(stormPoints, storm);
                    } else {
                        // Fallback to simple track
                        loadSimpleTrack(storm);
                    }
                } else {
                    loadSimpleTrack(storm);
                }
            } catch (error) {
                console.error('Error loading storm track:', error);
                loadSimpleTrack(storm);
            }
        }
        
        async function loadSimpleTrack(storm) {
            const decade = Math.floor(storm.year / 10) * 10;
            const tracksFile = `hurdat2_data/tracks_${decade}s.geojson`;
            
            try {
                const response = await fetch(tracksFile);
                if (response.ok) {
                    const data = await response.json();
                    const stormTrack = data.features.find(f => 
                        f.properties.storm_id === storm.storm_id
                    );
                    
                    if (stormTrack) {
                        const coords = stormTrack.geometry.coordinates.map(c => [c[1], c[0]]);
                        const color = getCategoryColor(storm.category);
                        
                        currentStormLayer = L.polyline(coords, {
                            color: color,
                            weight: 4,
                            opacity: 0.8
                        }).addTo(responseMap);
                        
                        // Fit map to track
                        const bounds = L.latLngBounds(coords);
                        responseMap.fitBounds(bounds, { padding: [50, 50] });
                    }
                }
            } catch (error) {
                console.error('Error loading simple track:', error);
            }
        }
        
        function drawStormTrack(pointFeatures, storm) {
            // Sort by datetime
            pointFeatures.sort((a, b) => {
                if (a.properties.datetime && b.properties.datetime) {
                    return new Date(a.properties.datetime) - new Date(b.properties.datetime);
                }
                return 0;
            });
            
            const allLatLngs = [];
            const trackGroup = L.layerGroup();
            
            // Draw colored segments (rainbow track)
            for (let i = 0; i < pointFeatures.length - 1; i++) {
                const current = pointFeatures[i];
                const next = pointFeatures[i + 1];
                
                const currentCoords = [current.geometry.coordinates[1], current.geometry.coordinates[0]];
                const nextCoords = [next.geometry.coordinates[1], next.geometry.coordinates[0]];
                
                allLatLngs.push(currentCoords);
                
                // Calculate category from wind speed
                const maxWind = Math.max(
                    current.properties.max_wind || 0,
                    next.properties.max_wind || 0
                );
                
                let category = 0;
                if (maxWind >= 137) category = 5;
                else if (maxWind >= 113) category = 4;
                else if (maxWind >= 96) category = 3;
                else if (maxWind >= 83) category = 2;
                else if (maxWind >= 64) category = 1;
                
                const segmentColor = getCategoryColor(category);
                
                L.polyline([currentCoords, nextCoords], {
                    color: segmentColor,
                    weight: 6,
                    opacity: 0.9
                }).addTo(trackGroup);
            }
            
            // Add to map
            currentStormLayer = trackGroup;
            trackGroup.addTo(responseMap);
            
            // Fit map to track
            if (allLatLngs.length > 0) {
                const bounds = L.latLngBounds(allLatLngs);
                responseMap.fitBounds(bounds, { padding: [50, 50] });
            }
        }
        
        function getCategoryColor(category) {
            const colors = {
                5: '#8B008B',  // Purple for Cat 5
                4: '#DC143C',  // Red for Cat 4
                3: '#FF8C00',  // Orange for Cat 3
                2: '#FFD700',  // Gold for Cat 2
                1: '#90EE90',  // Light green for Cat 1
                0: '#87CEEB',  // Sky blue for TS
                '-1': '#D3D3D3' // Light gray for TD
            };
            return colors[category] || '#D3D3D3';
        }
        
        function updateStatistics() {
            // Calculate totals
            let totalShelters = 0;
            let totalMeals = 0;
            let totalVolunteers = 0;
            let totalFamilies = 0;
            let totalCost = 0;
            
            rcOperations.forEach(op => {
                totalShelters += op.rc_response.estimated_shelters || Math.round(15 + op.rc_impact_score / 2);
                totalMeals += op.rc_response.estimated_meals || Math.round(50000 + op.rc_impact_score * 1000);
                totalVolunteers += op.rc_response.estimated_volunteers || Math.round(200 + op.rc_impact_score * 5);
                totalFamilies += Math.round((op.rc_impact_score * 100) + Math.random() * 500);
                totalCost += op.rc_response.actual_cost || Math.round(2 + op.rc_impact_score / 10);
            });
            
            document.getElementById('totalOperations').textContent = rcOperations.length;
            document.getElementById('totalShelters').textContent = totalShelters.toLocaleString();
            document.getElementById('totalMeals').textContent = (totalMeals / 1000000).toFixed(1) + 'M';
            document.getElementById('totalVolunteers').textContent = (totalVolunteers / 1000).toFixed(0) + 'K';
            document.getElementById('totalFamilies').textContent = (totalFamilies / 1000).toFixed(0) + 'K';
            document.getElementById('totalCost').textContent = '$' + totalCost.toFixed(0) + 'M';
        }

        function createResourcesChart() {
            // Aggregate by year
            const yearData = {};
            rcOperations.forEach(op => {
                if (!yearData[op.year]) {
                    yearData[op.year] = { shelters: 0, meals: 0, volunteers: 0, count: 0 };
                }
                yearData[op.year].shelters += op.rc_response.estimated_shelters || Math.round(15 + op.rc_impact_score / 2);
                yearData[op.year].meals += (op.rc_response.estimated_meals || Math.round(50000 + op.rc_impact_score * 1000)) / 1000000;
                yearData[op.year].volunteers += (op.rc_response.estimated_volunteers || Math.round(200 + op.rc_impact_score * 5)) / 100;
                yearData[op.year].count++;
            });
            
            const years = Object.keys(yearData).sort();
            
            const traces = [
                {
                    x: years,
                    y: years.map(y => yearData[y].shelters),
                    name: 'Shelters',
                    type: 'bar',
                    marker: { color: '#dc2626' }
                },
                {
                    x: years,
                    y: years.map(y => yearData[y].meals),
                    name: 'Meals (M)',
                    type: 'bar',
                    marker: { color: '#f59e0b' }
                },
                {
                    x: years,
                    y: years.map(y => yearData[y].volunteers),
                    name: 'Volunteers (100s)',
                    type: 'bar',
                    marker: { color: '#10b981' }
                }
            ];
            
            const layout = {
                barmode: 'group',
                showlegend: true,
                legend: { 
                    orientation: 'v', 
                    y: 1,
                    x: 1.02,
                    xanchor: 'left',
                    yanchor: 'top',
                    font: { size: 11 },
                    bgcolor: 'rgba(255,255,255,0.9)',
                    bordercolor: '#ccc',
                    borderwidth: 1
                },
                margin: { t: 20, r: 120, b: 40, l: 40 },
                xaxis: { title: '' },
                yaxis: { title: '' },
                height: 340
            };
            
            Plotly.newPlot('resourcesChart', traces, layout, { responsive: true, displayModeBar: false });
        }

        function setupEventListeners() {
            document.getElementById('operationFilter').addEventListener('change', (e) => {
                const level = e.target.value;
                const list = document.getElementById('operationsList');
                const operations = level === 'all' ? rcOperations : 
                    rcOperations.filter(op => op.rc_response.operation_type === `Level ${level}`);
                
                list.innerHTML = '';
                operations.forEach(op => {
                    const div = document.createElement('div');
                    div.className = `operation-card p-3 bg-white border rounded-lg cursor-pointer hover:bg-gray-50 ${op.rc_response.operation_type === 'Level 3' ? 'level-3' : op.rc_response.operation_type === 'Level 2' ? 'level-2' : 'level-1'}`;
                    div.onclick = () => selectOperation(op);
                    
                    div.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="font-bold">${op.name} (${op.year})</h4>
                                <p class="text-sm text-gray-600">Category ${op.category} • ${op.rc_response.operation_type}</p>
                            </div>
                            <div class="text-right">
                                <div class="text-lg font-bold text-red-600">${op.rc_impact_score}</div>
                                <div class="text-xs text-gray-500">SCORE</div>
                            </div>
                        </div>
                    `;
                    
                    list.appendChild(div);
                });
            });
        }

        function getMonthName(month) {
            const months = ['', 'January', 'February', 'March', 'April', 'May', 'June', 
                           'July', 'August', 'September', 'October', 'November', 'December'];
            return months[month] || '';
        }
    </script>
</body>
</html>