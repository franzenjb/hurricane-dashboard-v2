<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-State Hurricane Tracker - Fixed Layout v2</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="atlantic-storms-enhanced.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        /* Double the size of Plotly modebar buttons */
        .modebar-btn {
            font-size: 32px !important;
            width: 60px !important;
            height: 60px !important;
        }
        
        .modebar {
            height: 60px !important;
        }
        
        .modebar-group {
            height: 60px !important;
        }
        
        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .container {
            flex: 1;
            display: flex;
            background: white;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
        }
        
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .right-sidebar {
            width: 525px;
            background: #f5f5f5;
            border-left: 3px solid #007cba;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        
        .storm-info-panel {
            flex: 0 0 10%;
            background: white;
            border-bottom: 2px solid #ccc;
            padding: 12px;
            overflow: hidden;
        }
        
        .storm-banner {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 15px;
        }
        
        .storm-name-section {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .category-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 16px;
            flex-shrink: 0;
        }
        
        .storm-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            white-space: nowrap;
        }
        
        .stats-inline {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .stat-inline {
            text-align: center;
        }
        
        .stat-label {
            font-size: 9px;
            color: #666;
            text-transform: uppercase;
            margin-bottom: 2px;
        }
        
        .stat-value {
            font-size: 13px;
            font-weight: bold;
            color: #333;
        }
        
        .map-panel {
            flex: 0 0 60%;
            background: white;
            border-bottom: 2px solid #ccc;
            position: relative;
        }
        
        #map {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
        }
        
        .narrative-panel {
            flex: 0 0 30%;
            background: white;
            padding: 20px;
            overflow-y: auto;
        }
        
        .narrative-header {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
            border-bottom: 2px solid #007cba;
            padding-bottom: 5px;
        }
        
        .narrative-subtitle {
            font-size: 12px;
            color: #666;
            margin-bottom: 15px;
            font-style: italic;
        }
        
        .narrative-content {
            font-size: 16px;
            line-height: 1.6;
            color: #555;
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        
        .prototype-banner {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
            padding: 12px;
            text-align: center;
            font-weight: bold;
            font-size: 16px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .controls-header {
            background: #2C3E50;
            color: white;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .state-selector {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .state-selector label {
            font-weight: bold;
            font-size: 14px;
        }
        
        .multi-select {
            position: relative;
            min-width: 250px;
        }
        
        .select-button {
            background: white;
            color: #2C3E50;
            border: 2px solid #e74c3c;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            min-height: 40px;
        }
        
        .select-button:hover {
            background: #f8f9fa;
        }
        
        .dropdown-content {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #e74c3c;
            border-top: none;
            border-radius: 0 0 6px 6px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .dropdown-content.show {
            display: block;
        }
        
        .state-option {
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #2C3E50;
        }
        
        .state-option label {
            color: #2C3E50 !important;
            cursor: pointer;
        }
        
        #state-dropdown label {
            color: #2C3E50 !important;
        }
        
        .state-option:hover {
            background: #f8f9fa;
        }
        
        .state-option input[type="checkbox"] {
            margin: 0;
        }
        
        .region-header {
            background: #e74c3c;
            color: white;
            padding: 8px 12px;
            font-weight: bold;
            font-size: 13px;
            letter-spacing: 0.5px;
        }
        
        .time-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: nowrap;
        }
        
        .time-controls label {
            font-size: 14px;
            font-weight: bold;
        }
        
        .year-range {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .year-range input {
            width: 60px;
            padding: 4px 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
        }
        
        .update-button {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
        }
        
        .update-button:hover {
            background: #c0392b;
        }
        
        #timeline {
            flex: 1;
            width: 100%;
            height: 100%;
            z-index: 10;
            position: relative;
        }
        
        .stats-banner {
            background: #2C3E50 !important;
            color: white !important;
            padding: 15px 20px !important;
            text-align: center;
            font-size: 16px;
            line-height: 1.4;
            border-top: 3px solid #e74c3c;
            flex-shrink: 0;
        }
        
        .stats-banner strong {
            color: #e74c3c;
            font-weight: 600;
        }
        
        .selected-states {
            background: rgba(255,255,255,0.1);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        /* Legend styles */
        .map-legend {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            z-index: 1000;
            font-size: 12px;
        }
        
        .legend-title {
            font-weight: bold;
            margin-bottom: 8px;
            text-align: center;
            border-bottom: 1px solid #ddd;
            padding-bottom: 4px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin: 4px 0;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 8px;
            border: 2px solid white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        
        /* Mobile optimizations */
        @media (max-width: 768px) {
            .controls-header {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }
            
            .state-selector {
                justify-content: center;
            }
            
            .multi-select {
                min-width: 200px;
            }
            
            .time-controls {
                justify-content: center;
            }
            
            .stats-banner {
                font-size: 14px;
                padding: 12px 15px !important;
            }
        }
        
        /* Modal styles for storm details */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.75);
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 8px;
            width: 80%;
            max-width: 1000px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            padding: 20px;
            background-color: #2C3E50;
            color: white;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h2 {
            margin: 0;
            font-size: 24px;
        }
        
        .modal-body {
            padding: 20px;
            flex: 1;
            overflow-y: auto;
        }
        
        #storm-map {
            height: 400px;
            width: 100%;
            border-radius: 4px;
            margin: 15px 0;
        }
        
        .close {
            color: white;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }
        
        .close:hover {
            opacity: 0.7;
        }
    </style>
</head>
<body>
    <div class="prototype-banner">
        PROTOTYPE: Multi-State Hurricane Tracker | Select states to compare regional hurricane activity
    </div>
    
    <div class="container">
        <div class="main-content">
            <!-- Controls Header -->
            <div class="controls-header">
            <div class="state-selector">
                <label>Select States:</label>
                <div class="multi-select">
                    <div class="select-button" onclick="toggleDropdown()">
                        <span id="selected-display">Florida</span>
                        <span>▼</span>
                    </div>
                    <div id="state-dropdown" class="dropdown-content">
                        <div class="region-header">GULF COAST</div>
                        <div class="state-option" style="background: #f8f9fa; font-weight: bold;">
                            <input type="checkbox" id="SELECT_GULF" value="SELECT_GULF" onchange="selectGroup('gulf')">
                            <label for="SELECT_GULF">Select All Gulf Coast</label>
                        </div>
                        <div class="state-option">
                            <input type="checkbox" id="FL" value="FL" checked onchange="updateSelection()">
                            <label for="FL">Florida</label>
                        </div>
                        <div class="state-option">
                            <input type="checkbox" id="TX" value="TX" onchange="updateSelection()">
                            <label for="TX">Texas</label>
                        </div>
                        <div class="state-option">
                            <input type="checkbox" id="LA" value="LA" onchange="updateSelection()">
                            <label for="LA">Louisiana</label>
                        </div>
                        <div class="state-option">
                            <input type="checkbox" id="MS" value="MS" onchange="updateSelection()">
                            <label for="MS">Mississippi</label>
                        </div>
                        <div class="state-option">
                            <input type="checkbox" id="AL" value="AL" onchange="updateSelection()">
                            <label for="AL">Alabama</label>
                        </div>
                        
                        <div class="region-header">ATLANTIC COAST</div>
                        <div class="state-option" style="background: #f8f9fa; font-weight: bold;">
                            <input type="checkbox" id="SELECT_ATLANTIC" value="SELECT_ATLANTIC" onchange="selectGroup('atlantic')">
                            <label for="SELECT_ATLANTIC">Select All Atlantic Coast</label>
                        </div>
                        <div class="state-option">
                            <input type="checkbox" id="GA" value="GA" onchange="updateSelection()">
                            <label for="GA">Georgia</label>
                        </div>
                        <div class="state-option">
                            <input type="checkbox" id="SC" value="SC" onchange="updateSelection()">
                            <label for="SC">South Carolina</label>
                        </div>
                        <div class="state-option">
                            <input type="checkbox" id="NC" value="NC" onchange="updateSelection()">
                            <label for="NC">North Carolina</label>
                        </div>
                        <div class="state-option">
                            <input type="checkbox" id="VA" value="VA" onchange="updateSelection()">
                            <label for="VA">Virginia</label>
                        </div>
                        <div class="state-option">
                            <input type="checkbox" id="MD" value="MD" onchange="updateSelection()">
                            <label for="MD">Maryland</label>
                        </div>
                        <div class="state-option">
                            <input type="checkbox" id="DE" value="DE" onchange="updateSelection()">
                            <label for="DE">Delaware</label>
                        </div>
                        <div class="state-option">
                            <input type="checkbox" id="NJ" value="NJ" onchange="updateSelection()">
                            <label for="NJ">New Jersey</label>
                        </div>
                        <div class="state-option">
                            <input type="checkbox" id="NY" value="NY" onchange="updateSelection()">
                            <label for="NY">New York</label>
                        </div>
                        <div class="state-option">
                            <input type="checkbox" id="CT" value="CT" onchange="updateSelection()">
                            <label for="CT">Connecticut</label>
                        </div>
                        <div class="state-option">
                            <input type="checkbox" id="RI" value="RI" onchange="updateSelection()">
                            <label for="RI">Rhode Island</label>
                        </div>
                        <div class="state-option">
                            <input type="checkbox" id="MA" value="MA" onchange="updateSelection()">
                            <label for="MA">Massachusetts</label>
                        </div>
                        <div class="state-option">
                            <input type="checkbox" id="NH" value="NH" onchange="updateSelection()">
                            <label for="NH">New Hampshire</label>
                        </div>
                        <div class="state-option">
                            <input type="checkbox" id="ME" value="ME" onchange="updateSelection()">
                            <label for="ME">Maine</label>
                        </div>
                    </div>
                </div>
                <div class="selected-states" id="states-summary">
                    1 state selected
                </div>
            </div>
            
            <div class="time-controls">
                <label>Years:</label>
                <div class="year-range">
                    <input type="number" id="start-year" value="2010" min="1851" max="2024">
                    <span>to</span>
                    <input type="number" id="end-year" value="2024" min="1851" max="2024">
                </div>
                <button class="update-button" onclick="updateTimeline()">Update</button>
            </div>
            
            <!-- Storm Filtering Controls (same as timeline tab) -->
            <div class="filter-controls-section" style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #ddd;">
                <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                    <input type="text" id="nameFilter" placeholder="Search by name" style="padding: 8px 12px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; color: #333;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <label style="font-weight: bold; font-size: 14px; color: #333;">Categories:</label>
                        <div style="display: flex; gap: 12px;" id="categoryFilter">
                            <label style="display: flex; align-items: center; gap: 4px; cursor: pointer; color: #333;">
                                <input type="checkbox" value="0"> TS
                            </label>
                            <label style="display: flex; align-items: center; gap: 4px; cursor: pointer; color: #333;">
                                <input type="checkbox" value="1"> Cat 1
                            </label>
                            <label style="display: flex; align-items: center; gap: 4px; cursor: pointer; color: #333;">
                                <input type="checkbox" value="2"> Cat 2
                            </label>
                            <label style="display: flex; align-items: center; gap: 4px; cursor: pointer; color: #333;">
                                <input type="checkbox" value="3" checked> Cat 3
                            </label>
                            <label style="display: flex; align-items: center; gap: 4px; cursor: pointer; color: #333;">
                                <input type="checkbox" value="4" checked> Cat 4
                            </label>
                            <label style="display: flex; align-items: center; gap: 4px; cursor: pointer; color: #333;">
                                <input type="checkbox" value="5" checked> Cat 5
                            </label>
                        </div>
                    </div>
                    <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; color: #333;">
                        <input type="checkbox" id="landfallOnly"> Landfall Only
                    </label>
                    <button onclick="applyFilters()" style="padding: 8px 16px; background: #007cba; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">Apply Filters</button>
                    <button onclick="clearFilters()" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">Clear</button>
                </div>
            </div>
        </div>
        
            <div id="timeline"></div>
            
            <div class="stats-banner">
                <span id="stats-text">Loading multi-state hurricane data...</span>
                <div style="font-size: 12px; color: #bbb; margin-top: 8px;">
                    HURDAT2 Database | Multi-State Analysis | Research: jeff.franzen2@redcross.org
                </div>
            </div>
        </div>
        
        <div class="right-sidebar">
            <div class="storm-info-panel" id="stormInfoPanel">
                <div class="storm-banner">
                    <div class="storm-name-section">
                        <div class="category-icon" id="categoryIcon" style="background-color: #8B9DC3;">TS</div>
                        <div class="storm-title" id="stormTitle">Select a Storm</div>
                    </div>
                    <div class="stats-inline">
                        <div class="stat-inline">
                            <div class="stat-label">Date</div>
                            <div class="stat-value" id="statDate">-</div>
                        </div>
                        <div class="stat-inline">
                            <div class="stat-label">Wind</div>
                            <div class="stat-value" id="statWind">-</div>
                        </div>
                        <div class="stat-inline">
                            <div class="stat-label">Landfall</div>
                            <div class="stat-value" id="statLandfall">-</div>
                        </div>
                        <div class="stat-inline">
                            <div class="stat-label">Deaths</div>
                            <div class="stat-value" id="statDeaths">-</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="map-panel">
                <div id="map"></div>
                <div class="map-legend">
                    <div class="legend-title">Hurricane Categories</div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #8B9DC3;"></div>
                        <span>TS - Tropical Storm</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #5CB85C;"></div>
                        <span>Cat 1 (74-95 mph)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #F0AD4E;"></div>
                        <span>Cat 2 (96-110 mph)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #FF7F00;"></div>
                        <span>Cat 3 (111-129 mph)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #D9534F;"></div>
                        <span>Cat 4 (130-156 mph)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #8B008B;"></div>
                        <span>Cat 5 (≥157 mph)</span>
                    </div>
                </div>
            </div>
            <div class="narrative-panel" id="narrativePanel">
                <div class="narrative-header">Historical Narrative</div>
                <div class="narrative-subtitle">Select a storm with landfall history for detailed narrative information.</div>
                <div class="narrative-content" id="narrativeContent">
                </div>
            </div>
        </div>
    </div>

    <!-- Storm Details Modal -->
    <div id="stormModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Storm Details</h2>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div id="storm-map"></div>
                <div id="storm-narrative"></div>
            </div>
        </div>
    </div>

    <script>
        // Initialize map and state variables
        let map;
        let selectedStates = ['FL']; // Default to Florida
        let currentStartYear = 2010;
        let currentEndYear = 2024;
        
        function initMap() {
            console.log('Initializing Leaflet map for Multi-State tab...');
            const mapDiv = document.getElementById('map');
            if (!mapDiv) {
                console.error('Map div not found!');
                return;
            }
            
            // Set explicit height for the map div
            mapDiv.style.height = '100%';
            mapDiv.style.width = '100%';
            
            map = L.map('map').setView([32.0, -85.0], 5); // Centered on Gulf/Atlantic states
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors',
                maxZoom: 18
            }).addTo(map);
            
            console.log('Map initialized successfully');
        }
        
        // State management functions
        function updateSelection() {
            selectedStates = [];
            const checkboxes = document.querySelectorAll('#state-dropdown input[type="checkbox"]:checked');
            checkboxes.forEach(cb => {
                if (!cb.value.startsWith('SELECT_')) {
                    selectedStates.push(cb.value);
                }
            });
            
            // Update display
            const display = document.getElementById('selected-display');
            const summary = document.getElementById('states-summary');
            if (selectedStates.length === 0) {
                display.textContent = 'Select states...';
                summary.textContent = 'No states selected';
            } else if (selectedStates.length === 1) {
                display.textContent = selectedStates[0];
                summary.textContent = '1 state selected';
            } else {
                display.textContent = selectedStates.slice(0, 3).join(', ') + (selectedStates.length > 3 ? '...' : '');
                summary.textContent = `${selectedStates.length} states selected`;
            }
            
            applyFilters();
        }
        
        function toggleDropdown() {
            document.getElementById('state-dropdown').classList.toggle('show');
        }
        
        function selectGroup(group) {
            const gulfStates = ['FL', 'TX', 'LA', 'MS', 'AL'];
            const atlanticStates = ['GA', 'SC', 'NC', 'VA', 'MD', 'DE', 'NJ', 'NY', 'CT', 'RI', 'MA', 'NH', 'ME'];
            
            const states = group === 'gulf' ? gulfStates : atlanticStates;
            const selectAllCheckbox = document.getElementById(group === 'gulf' ? 'SELECT_GULF' : 'SELECT_ATLANTIC');
            const isChecked = selectAllCheckbox.checked;
            
            states.forEach(state => {
                const checkbox = document.getElementById(state);
                if (checkbox) checkbox.checked = isChecked;
            });
            
            updateSelection();
        }
        
        function updateTimeline() {
            currentStartYear = parseInt(document.getElementById('start-year').value);
            currentEndYear = parseInt(document.getElementById('end-year').value);
            applyFilters();
        }

        function updateStormInfoPanel(storm) {
            const panel = document.getElementById('stormInfoPanel');
            const icon = document.getElementById('categoryIcon');
            const title = document.getElementById('stormTitle');
            
            // Update header
            title.textContent = storm.name;
            icon.textContent = storm.category === 0 ? 'TS' : storm.category;
            icon.style.backgroundColor = getCategoryColor(storm.category);
            
            // Update stats using static data
            document.getElementById('statDate').textContent = `${getMonthName(storm.month)} ${storm.day}, ${storm.year}`;
            document.getElementById('statWind').textContent = `${storm.wind_mph} mph`;
            // Show landfall states (enhanced data)
            if (storm.landfall_states && storm.landfall_states.length > 0) {
                document.getElementById('statLandfall').textContent = storm.landfall_states.join(', ');
            } else {
                document.getElementById('statLandfall').textContent = 'No US Landfall';
            }
            document.getElementById('statDeaths').textContent = storm.deaths || '0';
            
            // Update narrative panel
            const narrativeContent = document.getElementById('narrativeContent');
            if (storm.narrative) {
                narrativeContent.textContent = storm.narrative;
            } else if (typeof STORM_NARRATIVES !== 'undefined' && STORM_NARRATIVES[storm.name]) {
                narrativeContent.textContent = STORM_NARRATIVES[storm.name];
            } else {
                const categoryText = storm.category === 0 ? 'tropical storm' : `Category ${storm.category} hurricane`;
                const landfallText = storm.landfall_states && storm.landfall_states.length > 0 
                    ? `making landfall in ${storm.landfall_states.join(', ')}` 
                    : 'remaining over open ocean';
                narrativeContent.textContent = `${storm.name} was a ${categoryText} that occurred in ${storm.year}, ${landfallText}. This storm did not cause significant documented impacts to warrant a detailed historical narrative.`;
            }
        }

        async function showStormOnMap(storm) {
            if (!map) return;
            
            clearMapLayers();
            
            // Try to load the full storm track
            const trackData = await loadStormTrack(storm);
            
            if (trackData) {
                console.log('Track data loaded, drawing storm track');
                // Draw the full storm track
                drawStormTrack(trackData, storm);
            } else {
                console.log('No track data found, showing single point');
                // Fallback to single point if no track data available
                if (storm.lat && storm.lon) {
                    const color = getCategoryColor(storm.category);
                    L.circleMarker([storm.lat, storm.lon], {
                        color: color,
                        fillColor: color,
                        fillOpacity: 0.7,
                        radius: 8
                    }).addTo(map).bindPopup(`<b>${storm.name}</b><br>Category ${storm.category}<br>${storm.wind_mph} mph`);
                    
                    map.setView([storm.lat, storm.lon], 6);
                }
            }
        }

        async function loadStormTrack(storm) {
            try {
                const decade = Math.floor(storm.year / 10) * 10;
                const pointsFile = `./hurdat2_data/points_${decade}s.geojson`;
                
                let pointsResponse = await fetch(pointsFile);
                if (pointsResponse.ok) {
                    const pointsData = await pointsResponse.json();
                    const pointFeatures = pointsData.features.filter(f => 
                        f.properties.storm_id === storm.storm_id
                    );
                    
                    if (pointFeatures.length > 0) {
                        console.log(`Found ${pointFeatures.length} track points - RAINBOW TRACK`);
                        return { type: 'points', features: pointFeatures };
                    }
                }
                
                // Fallback to track lines
                const tracksFile = `./hurdat2_data/tracks_${decade}s.geojson`;
                const tracksResponse = await fetch(tracksFile);
                if (tracksResponse.ok) {
                    const tracksData = await tracksResponse.json();
                    const feature = tracksData.features.find(f => 
                        f.properties.storm_id === storm.storm_id
                    );
                    
                    if (feature && feature.geometry.type === 'LineString') {
                        console.log(`Found track line - SINGLE COLOR TRACK`);
                        return { type: 'line', geometry: feature.geometry };
                    }
                }
                
                return null;
            } catch (error) {
                console.error('Error loading storm track:', error);
                return null;
            }
        }

        function drawStormTrack(trackData, storm) {
            if (trackData.type === 'points' && trackData.features) {
                drawRainbowTrack(trackData.features, storm);
            } else if (trackData.type === 'line' && trackData.geometry) {
                drawSimpleTrack(trackData.geometry, storm);
            }
        }

        function drawRainbowTrack(pointFeatures, storm) {
            if (pointFeatures.length === 0) return;
            
            // Sort by datetime
            pointFeatures.sort((a, b) => {
                if (a.properties.datetime && b.properties.datetime) {
                    return new Date(a.properties.datetime) - new Date(b.properties.datetime);
                }
                return 0;
            });
            
            const allLatLngs = [];
            
            // Draw colored segments between points
            for (let i = 0; i < pointFeatures.length - 1; i++) {
                const current = pointFeatures[i];
                const next = pointFeatures[i + 1];
                
                const currentCoords = [current.geometry.coordinates[1], current.geometry.coordinates[0]];
                const nextCoords = [next.geometry.coordinates[1], next.geometry.coordinates[0]];
                
                allLatLngs.push(currentCoords);
                
                // Use the higher category of the two points for segment color
                const category = Math.max(
                    current.properties.usa_status || 0,
                    next.properties.usa_status || 0
                );
                
                const segmentColor = getCategoryColor(category);
                
                L.polyline([currentCoords, nextCoords], {
                    color: segmentColor,
                    weight: 4,
                    opacity: 0.9
                }).addTo(map);
            }
            
            // Add last point
            if (pointFeatures.length > 0) {
                const lastPoint = pointFeatures[pointFeatures.length - 1];
                allLatLngs.push([lastPoint.geometry.coordinates[1], lastPoint.geometry.coordinates[0]]);
            }
            
            // Add start and end markers
            if (allLatLngs.length >= 2) {
                // Start marker (green)
                L.circleMarker(allLatLngs[0], {
                    color: '#00ff00',
                    fillColor: '#00ff00',
                    fillOpacity: 0.8,
                    radius: 6,
                    weight: 2
                }).addTo(map).bindPopup(`<b>${storm.name}</b><br>Track Start`);
                
                // End marker (category color)
                const endColor = getCategoryColor(storm.category);
                L.circleMarker(allLatLngs[allLatLngs.length - 1], {
                    color: endColor,
                    fillColor: endColor,
                    fillOpacity: 0.9,
                    radius: 8,
                    weight: 3
                }).addTo(map).bindPopup(`<b>${storm.name}</b><br>Peak: Cat ${storm.category}, ${storm.wind_mph} mph`);
            }
            
            // Fit map to show track
            if (allLatLngs.length > 0) {
                map.fitBounds(allLatLngs, {padding: [20, 20]});
            }
        }

        function drawSimpleTrack(geometry, storm) {
            const coords = geometry.coordinates.map(coord => [coord[1], coord[0]]);
            const stormColor = getCategoryColor(storm.category);
            
            L.polyline(coords, {
                color: stormColor,
                weight: 4,
                opacity: 0.9
            }).addTo(map);
            
            // Add start and end markers
            if (coords.length >= 2) {
                // Start marker (green)
                L.circleMarker(coords[0], {
                    color: '#00ff00',
                    fillColor: '#00ff00',
                    fillOpacity: 0.8,
                    radius: 6,
                    weight: 2
                }).addTo(map).bindPopup(`<b>${storm.name}</b><br>Track Start`);
                
                // End marker (category color)
                L.circleMarker(coords[coords.length - 1], {
                    color: stormColor,
                    fillColor: stormColor,
                    fillOpacity: 0.9,
                    radius: 8,
                    weight: 3
                }).addTo(map).bindPopup(`<b>${storm.name}</b><br>Peak: Cat ${storm.category}, ${storm.wind_mph} mph`);
            }
            
            // Fit map to show track
            map.fitBounds(coords, {padding: [20, 20]});
        }

        function clearMapLayers() {
            if (!map) return;
            map.eachLayer(function(layer) {
                if (layer instanceof L.Marker || layer instanceof L.Polyline) {
                    map.removeLayer(layer);
                }
            });
        }

        // Helper functions
        function getMonthName(month) {
            const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
            return months[month-1] || 'Unknown';
        }

        function getCategoryColor(category) {
            const colors = {
                0: "#8B9DC3",   // Tropical Storm - Steel Blue
                1: "#5CB85C",   // Cat 1 - Green
                2: "#F0AD4E",   // Cat 2 - Yellow-Orange
                3: "#FF7F00",   // Cat 3 - Orange
                4: "#D9534F",   // Cat 4 - Red
                5: "#8B008B"    // Cat 5 - Dark Magenta
            };
            return colors[category] || "#757575";
        }
        
        function isLikelyUSLandfall(storm) {
            // Check if storm has landfall_states data
            if (storm.landfall_states && storm.landfall_states.length > 0) {
                return true;
            }
            
            // Fallback: Check if max lat > 25 and west of -65 (US coast region)
            if (storm.lat && storm.lon) {
                return storm.lat > 25 && storm.lon > -100 && storm.lon < -65;
            }
            
            return false;
        }
        
        function applyFilters() {
            const nameFilter = document.getElementById('nameFilter').value.toLowerCase();
            const landfallOnly = document.getElementById('landfallOnly').checked;
            
            // Get selected categories from checkboxes
            const selectedCategories = [];
            const categoryCheckboxes = document.querySelectorAll('#categoryFilter input[type="checkbox"]:checked');
            categoryCheckboxes.forEach(checkbox => {
                selectedCategories.push(parseInt(checkbox.value));
            });
            
            // Apply filters to storms for the selected states
            const allStorms = ATLANTIC_STORMS_ENHANCED.filter(storm => {
                const isSelectedState = selectedStates.some(state => 
                    storm.landfall_states && storm.landfall_states.includes(state)
                );
                const inYearRange = storm.year >= currentStartYear && storm.year <= currentEndYear;
                
                if (!isSelectedState || !inYearRange) return false;
                
                // If name search is active, ONLY filter by name - ignore all other filters
                if (nameFilter) {
                    return storm.name.toLowerCase().includes(nameFilter);
                }
                
                // Otherwise apply normal filters
                if (selectedCategories.length > 0 && !selectedCategories.includes(storm.category)) return false;
                // Only show hurricane season months (Jun-Dec: months 6-12)
                if (storm.month < 6 || storm.month > 12) return false;
                // Filter for landfall storms if checkbox is checked
                if (landfallOnly && !isLikelyUSLandfall(storm)) return false;
                return true;
            });
            
            // If name search is active and found storms, adjust year range to show results
            if (nameFilter && allStorms.length > 0) {
                const stormYears = allStorms.map(s => s.year);
                const minStormYear = Math.min(...stormYears);
                const maxStormYear = Math.max(...stormYears);
                
                // Only adjust if storms are outside current range
                if (minStormYear < currentStartYear || maxStormYear > currentEndYear) {
                    currentStartYear = Math.min(minStormYear, currentStartYear);
                    currentEndYear = Math.max(maxStormYear, currentEndYear);
                    
                    // Update the year input fields
                    document.getElementById('start-year').value = currentStartYear;
                    document.getElementById('end-year').value = currentEndYear;
                    
                    console.log(`Name search found storms from ${minStormYear}-${maxStormYear}, adjusted range to ${currentStartYear}-${currentEndYear}`);
                }
            }
            
            // Update the stats banner
            updateStatsDisplay(allStorms);
            // Plot storms on map
            plotStormsOnMap(allStorms);
        }
        
        function updateStatsDisplay(storms) {
            const statsText = document.getElementById('stats-text');
            if (storms.length === 0) {
                statsText.textContent = 'No storms found matching your criteria';
            } else {
                const cat5Count = storms.filter(s => s.category === 5).length;
                const cat4Count = storms.filter(s => s.category === 4).length;
                const cat3Count = storms.filter(s => s.category === 3).length;
                statsText.innerHTML = `<strong>${storms.length}</strong> storms found | ` +
                    `<strong>${cat5Count}</strong> Cat 5 | <strong>${cat4Count}</strong> Cat 4 | <strong>${cat3Count}</strong> Cat 3`;
            }
        }

        // Move initialization to after variables are defined
        function initializeMapAndData() {
            console.log('Initializing map and data...');
            initMap();
            // Initialize with default filters to show storm markers
            setTimeout(() => {
                console.log('Applying initial filters...');
                if (typeof selectedStates !== 'undefined') {
                    console.log('Selected states:', selectedStates);
                    applyFilters();
                } else {
                    console.error('selectedStates not defined yet!');
                }
            }, 500);
        }

        // EXPANDED MULTI-STATE HURRICANE DATA (1851-2024)
        // Includes historical storms from HURDAT2 database
        
        // Storm paths with category data
        const STORM_PATHS = {
            "Dennis": [
                {lat: 11.2, lon: -61.6, category: 0, date: "2005-07-04"},
                {lat: 12.1, lon: -64.7, category: 1, date: "2005-07-05"},
                {lat: 13.5, lon: -68.5, category: 2, date: "2005-07-06"},
                {lat: 16.0, lon: -73.5, category: 3, date: "2005-07-07"},
                {lat: 18.7, lon: -77.5, category: 4, date: "2005-07-08"},
                {lat: 21.5, lon: -81.0, category: 4, date: "2005-07-09"},
                {lat: 25.5, lon: -85.5, category: 3, date: "2005-07-10"},
                {lat: 30.3, lon: -87.0, category: 3, date: "2005-07-10"}
            ],
            "Wilma": [
                {lat: 14.5, lon: -78.5, category: 0, date: "2005-10-15"},
                {lat: 15.7, lon: -79.6, category: 1, date: "2005-10-17"},
                {lat: 16.5, lon: -80.3, category: 4, date: "2005-10-18"},
                {lat: 17.9, lon: -82.1, category: 5, date: "2005-10-19"},
                {lat: 20.6, lon: -86.8, category: 4, date: "2005-10-21"},
                {lat: 23.0, lon: -88.5, category: 3, date: "2005-10-23"},
                {lat: 25.9, lon: -81.7, category: 3, date: "2005-10-24"},
                {lat: 27.5, lon: -79.0, category: 2, date: "2005-10-24"}
            ],
            "Irma": [
                {lat: 16.3, lon: -30.3, category: 0, date: "2017-08-30"},
                {lat: 16.4, lon: -32.2, category: 1, date: "2017-08-31"},
                {lat: 16.7, lon: -38.0, category: 3, date: "2017-09-01"},
                {lat: 16.9, lon: -48.0, category: 5, date: "2017-09-04"},
                {lat: 17.2, lon: -57.7, category: 5, date: "2017-09-05"},
                {lat: 18.1, lon: -63.1, category: 5, date: "2017-09-06"},
                {lat: 20.0, lon: -68.3, category: 5, date: "2017-09-07"},
                {lat: 21.5, lon: -71.5, category: 5, date: "2017-09-08"},
                {lat: 22.0, lon: -75.5, category: 4, date: "2017-09-09"},
                {lat: 23.5, lon: -80.5, category: 4, date: "2017-09-10"},
                {lat: 24.7, lon: -81.5, category: 4, date: "2017-09-10"},
                {lat: 26.5, lon: -81.7, category: 3, date: "2017-09-10"}
            ],
            "Michael": [
                {lat: 14.0, lon: -84.0, category: 0, date: "2018-10-07"},
                {lat: 17.2, lon: -84.4, category: 1, date: "2018-10-08"},
                {lat: 19.7, lon: -85.0, category: 2, date: "2018-10-09"},
                {lat: 23.0, lon: -85.5, category: 3, date: "2018-10-09"},
                {lat: 26.0, lon: -85.7, category: 4, date: "2018-10-10"},
                {lat: 28.5, lon: -85.5, category: 5, date: "2018-10-10"},
                {lat: 29.9, lon: -85.4, category: 5, date: "2018-10-10"},
                {lat: 32.0, lon: -84.5, category: 1, date: "2018-10-11"}
            ],
            "Idalia": [
                {lat: 20.0, lon: -84.0, category: 0, date: "2023-08-27"},
                {lat: 21.5, lon: -85.0, category: 1, date: "2023-08-28"},
                {lat: 23.0, lon: -85.5, category: 2, date: "2023-08-29"},
                {lat: 25.5, lon: -85.0, category: 3, date: "2023-08-29"},
                {lat: 27.5, lon: -84.5, category: 4, date: "2023-08-30"},
                {lat: 29.8, lon: -83.6, category: 3, date: "2023-08-30"},
                {lat: 31.5, lon: -82.0, category: 1, date: "2023-08-30"}
            ],
            "Ian": [
                {lat: 14.0, lon: -65.0, category: 0, date: "2022-09-23"},
                {lat: 15.0, lon: -69.0, category: 1, date: "2022-09-24"},
                {lat: 16.5, lon: -73.0, category: 1, date: "2022-09-25"},
                {lat: 18.0, lon: -77.0, category: 3, date: "2022-09-26"},
                {lat: 20.0, lon: -81.0, category: 3, date: "2022-09-27"},
                {lat: 22.5, lon: -83.0, category: 4, date: "2022-09-27"},
                {lat: 24.5, lon: -83.0, category: 5, date: "2022-09-28"},
                {lat: 26.7, lon: -82.2, category: 4, date: "2022-09-28"},
                {lat: 28.5, lon: -81.5, category: 1, date: "2022-09-29"}
            ],
            "Helene": [
                {lat: 18.0, lon: -84.5, category: 0, date: "2024-09-24"},
                {lat: 19.5, lon: -85.0, category: 1, date: "2024-09-24"},
                {lat: 21.0, lon: -85.5, category: 2, date: "2024-09-25"},
                {lat: 23.0, lon: -85.7, category: 3, date: "2024-09-25"},
                {lat: 25.5, lon: -85.0, category: 4, date: "2024-09-26"},
                {lat: 28.0, lon: -84.2, category: 4, date: "2024-09-26"},
                {lat: 30.1, lon: -83.6, category: 4, date: "2024-09-26"},
                {lat: 32.5, lon: -83.0, category: 1, date: "2024-09-27"}
            ],
            "Milton": [
                {lat: 19.5, lon: -92.5, category: 0, date: "2024-10-05"},
                {lat: 20.5, lon: -93.0, category: 1, date: "2024-10-06"},
                {lat: 21.5, lon: -92.5, category: 5, date: "2024-10-07"},
                {lat: 22.5, lon: -90.5, category: 5, date: "2024-10-08"},
                {lat: 24.0, lon: -87.5, category: 4, date: "2024-10-08"},
                {lat: 26.0, lon: -84.5, category: 4, date: "2024-10-09"},
                {lat: 27.3, lon: -82.5, category: 3, date: "2024-10-09"},
                {lat: 28.0, lon: -80.5, category: 1, date: "2024-10-10"}
            ],
            "Charley": [
                {lat: 22.0, lon: -77.0, category: 1, date: "2004-08-12"},
                {lat: 24.0, lon: -79.0, category: 2, date: "2004-08-12"},
                {lat: 25.5, lon: -81.5, category: 3, date: "2004-08-13"},
                {lat: 26.7, lon: -82.2, category: 4, date: "2004-08-13"},
                {lat: 28.0, lon: -81.5, category: 3, date: "2004-08-13"},
                {lat: 29.2, lon: -81.0, category: 2, date: "2004-08-14"}
            ],
            "Frances": [
                {lat: 24.0, lon: -74.0, category: 2, date: "2004-09-04"},
                {lat: 26.0, lon: -78.0, category: 2, date: "2004-09-05"},
                {lat: 27.2, lon: -80.2, category: 2, date: "2004-09-05"},
                {lat: 28.5, lon: -81.0, category: 1, date: "2004-09-06"}
            ],
            "Jeanne": [
                {lat: 25.0, lon: -75.0, category: 3, date: "2004-09-25"},
                {lat: 26.5, lon: -78.0, category: 3, date: "2004-09-26"},
                {lat: 27.3, lon: -80.2, category: 3, date: "2004-09-26"},
                {lat: 29.0, lon: -81.0, category: 2, date: "2004-09-27"}
            ],
            "Katrina": [
                {lat: 23.1, lon: -75.1, category: 0, date: "2005-08-23"},
                {lat: 23.4, lon: -75.7, category: 0, date: "2005-08-24"},
                {lat: 25.4, lon: -77.0, category: 1, date: "2005-08-25"},
                {lat: 26.0, lon: -80.3, category: 1, date: "2005-08-25"},
                {lat: 26.2, lon: -82.0, category: 1, date: "2005-08-26"},
                {lat: 26.5, lon: -84.0, category: 2, date: "2005-08-27"},
                {lat: 27.2, lon: -87.5, category: 4, date: "2005-08-28"},
                {lat: 28.5, lon: -89.5, category: 5, date: "2005-08-29"},
                {lat: 29.3, lon: -89.6, category: 3, date: "2005-08-29"}
            ],
            "Hermine": [
                {lat: 23.8, lon: -83.0, category: 0, date: "2016-08-28"},
                {lat: 25.0, lon: -84.0, category: 0, date: "2016-08-31"},
                {lat: 27.5, lon: -84.5, category: 1, date: "2016-09-01"},
                {lat: 29.5, lon: -84.3, category: 1, date: "2016-09-02"},
                {lat: 30.2, lon: -84.2, category: 1, date: "2016-09-02"},
                {lat: 32.0, lon: -83.5, category: 0, date: "2016-09-02"}
            ]
        };

        // Storm narratives
        const STORM_NARRATIVES = {
            "Charley": "Hurricane Charley (August 2004) was a compact but extremely destructive Category 4 hurricane that made landfall near Cayo Costa with 150 mph winds. The storm was notable for its unexpected northward turn that brought the eye directly over Charlotte Harbor and up through Central Florida. Charley caused extensive damage in Punta Gorda, Port Charlotte, and Orlando, and was the first of four hurricanes to strike Florida in 2004. The storm's small size and rapid intensification caught many off guard.",
            
            "Frances": "Hurricane Frances (September 2004) was a large Category 2 storm that made landfall near Sewall's Point with 105 mph winds. The hurricane's large size caused widespread damage across Central and East Florida, with millions losing power for extended periods. Frances was part of the unprecedented 2004 hurricane season that saw four hurricanes strike Florida.",
            
            "Jeanne": "Hurricane Jeanne (September 2004) was a Category 3 storm that made landfall near Hutchinson Island with 120 mph winds. Remarkably, Jeanne struck nearly the same area as Hurricane Frances just weeks earlier, compounding the damage and creating unprecedented challenges for recovery efforts. The storm highlighted the importance of long-term disaster planning.",
            
            "Dennis": "Hurricane Dennis (July 2005) was an early-season Category 4 hurricane that caused significant damage across the western Florida Panhandle. Making landfall near Pensacola as a Category 3 storm with 120 mph winds, Dennis arrived just 10 months after Hurricane Ivan had devastated the same region. The storm caused extensive structural damage, widespread power outages affecting over 700,000 customers, and dangerous storm surge flooding along the coast. Dennis resulted in 14 deaths in Florida and over $2.5 billion in damage, marking it as one of the strongest July hurricanes on record.",
            
            "Katrina": "Hurricane Katrina (August 2005) first impacted Florida as a Category 1 hurricane, crossing the southern tip of the state before strengthening into the catastrophic storm that would devastate the Gulf Coast. Making landfall near Hallandale Beach with 80 mph winds, Katrina caused significant flooding in Miami-Dade and Broward counties, spawned tornadoes, and knocked out power to over 1.4 million customers. Though Florida's impact was overshadowed by the later devastation in Louisiana and Mississippi, the storm still caused 14 deaths and hundreds of millions in damage across South Florida. Katrina then strengthened over the Gulf of Mexico to become one of the deadliest hurricanes in U.S. history.",
            
            "Wilma": "Hurricane Wilma (October 2005) was the most intense Atlantic hurricane on record and the last major hurricane to strike Florida until Irma in 2017. After devastating the Yucatan Peninsula, Wilma crossed Florida from southwest to northeast as a Category 3 storm, making landfall near Cape Romano with 120 mph winds. The hurricane's large eye passed directly over heavily populated areas including Naples, Fort Myers, and West Palm Beach, causing catastrophic damage. Wilma left 3.4 million Floridians without power, caused the largest evacuation in state history, and resulted in 35 deaths and $21 billion in damage.",
            
            "Hermine": "Hurricane Hermine (September 2016) ended Florida's record 11-year hurricane drought, making landfall in the Big Bend area as a Category 1 storm with 80 mph winds. The storm struck near St. Marks just after midnight, bringing heavy rainfall, storm surge, and widespread power outages to North Florida. Hermine caused significant flooding in coastal communities, downed thousands of trees, and left nearly 300,000 customers without electricity. Though only a Category 1, the storm served as a wake-up call after Florida's long hurricane-free period.",
            
            "Irma": "Hurricane Irma (September 2017) was one of the strongest Atlantic hurricanes ever recorded, maintaining Category 5 intensity for 37 hours. The massive storm made landfall in the Florida Keys as a Category 4 with 130 mph winds before striking mainland Florida near Marco Island. Irma's enormous size meant the entire state experienced hurricane conditions, with devastating storm surge in the Keys, widespread flooding, and catastrophic wind damage. The storm prompted the largest evacuation in U.S. history with 6.5 million Floridians ordered to leave, resulted in 92 deaths, and caused $50 billion in damage statewide.",
            
            "Michael": "Hurricane Michael (October 2018) rapidly intensified into a catastrophic Category 5 hurricane, becoming the strongest storm to hit the Florida Panhandle in recorded history. Making landfall near Mexico Beach with 160 mph winds and a 14-foot storm surge, Michael obliterated entire communities, flattened forests, and caused unprecedented destruction across the Panhandle. The storm's rapid intensification gave residents little time to prepare, and its extreme winds extended well inland, devastating agricultural areas. Michael caused 16 deaths in Florida and over $25 billion in damage, with some communities still recovering years later.",
            
            "Ian": "Hurricane Ian (September 2022) was a catastrophic Category 4 hurricane that devastated Southwest Florida, ranking among the costliest natural disasters in U.S. history. Making landfall at Cayo Costa with 150 mph winds, Ian brought unprecedented storm surge of 12-18 feet to Fort Myers Beach and surrounding areas, essentially wiping some coastal communities off the map. The slow-moving storm dumped torrential rainfall causing historic flooding across Central Florida, knocked out power to 2.6 million customers, and destroyed thousands of homes. Ian resulted in 149 deaths in Florida and caused over $112 billion in damage.",
            
            "Idalia": "Hurricane Idalia (August 2023) rapidly intensified into a major hurricane before making landfall in Florida's Big Bend region as a powerful Category 3 storm with 125 mph winds. Striking near Keaton Beach, Idalia brought destructive storm surge to the sparsely populated coastline, with water levels reaching 7-12 feet above normal. The hurricane maintained significant strength inland, causing widespread wind damage and flooding across North Florida and into Georgia. Despite hitting a less populated area, Idalia still caused 8 deaths and billions in agricultural and property damage.",
            
            "Helene": "Hurricane Helene (September 2024) was a large and powerful Category 4 hurricane that brought devastating impacts to Florida's Big Bend before causing catastrophic flooding in the Southeastern U.S. Making landfall near Perry with 140 mph winds, Helene's massive size meant hurricane-force winds extended far from the center, affecting most of North Florida. The storm surge reached 15 feet in some areas, while the fast-moving system brought destructive winds well inland. Helene caused 230 deaths across multiple states, with Florida experiencing significant coastal and inland damage.",
            
            "Milton": "Hurricane Milton (October 2024) underwent explosive intensification to Category 5 strength in the Gulf of Mexico before weakening to Category 3 at landfall near Siesta Key. Despite the weakening, Milton brought devastating storm surge to areas still recovering from Hurricane Ian, along with destructive winds and dozens of tornadoes across Central Florida. The hurricane cut across the state, maintaining significant strength and knocking out power to over 3 million customers. Milton caused 35 deaths and billions in additional damage to communities struggling to rebuild from previous storms."
        };

        // Get category color
        function getCategoryColor(category) {
            const colors = {
                0: "#8B9DC3",   // Tropical Storm - Steel Blue
                1: "#5CB85C",   // Cat 1 - Green
                2: "#F0AD4E",   // Cat 2 - Yellow-Orange
                3: "#FF7F00",   // Cat 3 - Orange
                4: "#D9534F",   // Cat 4 - Red
                5: "#8B008B"    // Cat 5 - Dark Magenta
            };
            return colors[category] || "#757575";
        }
        
        // Enhanced landfall detection using analyzed track data (same as timeline tab)
        function isLikelyUSLandfall(storm) {
            // Use the enhanced landfall_states array if available
            if (storm.landfall_states && Array.isArray(storm.landfall_states)) {
                return storm.landfall_states.length > 0;
            }
            
            // Fallback to coordinate-based detection for older data
            if (!storm.lat || !storm.lon) return false;
            
            // Atlantic basin US landfall areas only
            const ATLANTIC_US_LANDFALL_BOUNDS = {
                // East Coast: Maine to Florida Keys
                eastCoast: {
                    north: 47.5, south: 24.3, east: -66.0, west: -87.0
                },
                // Gulf Coast: Florida to Texas (Atlantic storms that enter Gulf)
                gulfCoast: {
                    north: 32.0, south: 24.0, east: -80.0, west: -98.0
                },
                // Puerto Rico and US Virgin Islands (Atlantic territories)
                caribbeanTerritories: {
                    north: 18.6, south: 17.6, east: -64.5, west: -67.5
                }
            };
            
            const lat = storm.lat;
            const lon = storm.lon;
            
            // Check if coordinates fall within Atlantic basin US landfall zones
            const inEastCoast = (lat >= ATLANTIC_US_LANDFALL_BOUNDS.eastCoast.south && 
                               lat <= ATLANTIC_US_LANDFALL_BOUNDS.eastCoast.north &&
                               lon >= ATLANTIC_US_LANDFALL_BOUNDS.eastCoast.west && 
                               lon <= ATLANTIC_US_LANDFALL_BOUNDS.eastCoast.east);
                               
            const inGulfCoast = (lat >= ATLANTIC_US_LANDFALL_BOUNDS.gulfCoast.south && 
                               lat <= ATLANTIC_US_LANDFALL_BOUNDS.gulfCoast.north &&
                               lon >= ATLANTIC_US_LANDFALL_BOUNDS.gulfCoast.west && 
                               lon <= ATLANTIC_US_LANDFALL_BOUNDS.gulfCoast.east);
                               
            const inCaribbean = (lat >= ATLANTIC_US_LANDFALL_BOUNDS.caribbeanTerritories.south && 
                               lat <= ATLANTIC_US_LANDFALL_BOUNDS.caribbeanTerritories.north &&
                               lon >= ATLANTIC_US_LANDFALL_BOUNDS.caribbeanTerritories.west && 
                               lon <= ATLANTIC_US_LANDFALL_BOUNDS.caribbeanTerritories.east);
            
            return inEastCoast || inGulfCoast || inCaribbean;
        }
        
        // Storm filtering functions (same as timeline tab)
        function applyFilters() {
            const nameFilter = document.getElementById('nameFilter').value.toLowerCase();
            const landfallOnly = document.getElementById('landfallOnly').checked;
            
            // Get selected categories from checkboxes
            const selectedCategories = [];
            const categoryCheckboxes = document.querySelectorAll('#categoryFilter input[type="checkbox"]:checked');
            categoryCheckboxes.forEach(checkbox => {
                selectedCategories.push(parseInt(checkbox.value));
            });
            
            // Apply filters to storms for the selected states
            const allStorms = ATLANTIC_STORMS_ENHANCED.filter(storm => {
                const isSelectedState = selectedStates.some(state => 
                    storm.landfall_states && storm.landfall_states.includes(state)
                );
                const inYearRange = storm.year >= currentStartYear && storm.year <= currentEndYear;
                
                if (!isSelectedState || !inYearRange) return false;
                
                // If name search is active, ONLY filter by name - ignore all other filters
                if (nameFilter) {
                    return storm.name.toLowerCase().includes(nameFilter);
                }
                
                // Otherwise apply normal filters
                if (selectedCategories.length > 0 && !selectedCategories.includes(storm.category)) return false;
                // Only show hurricane season months (Jun-Dec: months 6-12)
                if (storm.month < 6 || storm.month > 12) return false;
                // Filter for landfall storms if checkbox is checked
                if (landfallOnly && !isLikelyUSLandfall(storm)) return false;
                return true;
            });
            
            // If name search is active and found storms, adjust year range to show results
            if (nameFilter && allStorms.length > 0) {
                const stormYears = allStorms.map(s => s.year);
                const minStormYear = Math.min(...stormYears);
                const maxStormYear = Math.max(...stormYears);
                
                // Only adjust if storms are outside current range
                if (minStormYear < currentStartYear || maxStormYear > currentEndYear) {
                    currentStartYear = Math.min(minStormYear, currentStartYear);
                    currentEndYear = Math.max(maxStormYear, currentEndYear);
                    
                    // Update the year input fields
                    document.getElementById('start-year').value = currentStartYear;
                    document.getElementById('end-year').value = currentEndYear;
                    
                    console.log(`Name search found storms from ${minStormYear}-${maxStormYear}, adjusted range to ${currentStartYear}-${currentEndYear}`);
                }
            }
            
            updateTimeline();
            plotStormsOnMap(allStorms);
        }
        
        function plotStormsOnMap(storms) {
            console.log('plotStormsOnMap called with', storms.length, 'storms');
            if (!map) {
                console.error('Map not initialized!');
                return;
            }
            
            // Clear existing storm markers
            map.eachLayer(function(layer) {
                if (layer instanceof L.CircleMarker || layer instanceof L.Marker) {
                    map.removeLayer(layer);
                }
            });
            
            console.log('Adding storm markers to map...');
            let markersAdded = 0;
            
            // Add markers for each storm
            storms.forEach(storm => {
                if (storm.lat && storm.lon) {
                    const color = getCategoryColor(storm.category);
                    const marker = L.circleMarker([storm.lat, storm.lon], {
                        radius: 6 + (storm.category * 1.5),
                        fillColor: color,
                        color: '#fff',
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 0.8
                    });
                    
                    // Add popup with storm info
                    marker.bindPopup(`
                        <div style="min-width: 200px;">
                            <h3 style="margin: 0 0 8px 0; font-weight: bold;">
                                ${storm.name} (${storm.year})
                            </h3>
                            <div style="font-size: 14px;">
                                <div>Category: ${storm.category}</div>
                                <div>Wind: ${storm.wind_mph} mph</div>
                                <div>Date: ${getMonthName(storm.month)} ${storm.day}</div>
                                ${storm.landfall_states ? `<div>States: ${storm.landfall_states.join(', ')}</div>` : ''}
                                ${storm.deaths ? `<div>Deaths: ${storm.deaths}</div>` : ''}
                            </div>
                        </div>
                    `);
                    
                    // Add click handler to show full storm details
                    marker.on('click', function() {
                        showStormOnMap(storm);
                        updateStormInfoPanel(storm);
                    });
                    
                    marker.addTo(map);
                    markersAdded++;
                }
            });
            
            console.log('Added', markersAdded, 'markers to map');
            
            // Adjust map view to show all markers if there are any
            if (storms.length > 0) {
                const group = new L.featureGroup(
                    storms.filter(s => s.lat && s.lon)
                          .map(s => L.marker([s.lat, s.lon]))
                );
                if (group.getLayers().length > 0) {
                    map.fitBounds(group.getBounds().pad(0.1));
                }
            }
        }
        
        function clearFilters() {
            document.getElementById('nameFilter').value = '';
            
            // Reset category checkboxes to initial page load state (only Cat 3-5)
            const categoryCheckboxes = document.querySelectorAll('#categoryFilter input[type="checkbox"]');
            categoryCheckboxes.forEach(checkbox => {
                const category = parseInt(checkbox.value);
                checkbox.checked = (category >= 3); // Only Cat 3, 4, 5 checked by default
            });
            
            // Reset landfall filter
            document.getElementById('landfallOnly').checked = false;
            
            // Reset year range
            currentStartYear = 2010;
            currentEndYear = new Date().getFullYear();
            document.getElementById('start-year').value = currentStartYear;
            document.getElementById('end-year').value = currentEndYear;
            
            // Reset map view if available
            if (map) {
                map.eachLayer(function(layer) {
                    if (layer instanceof L.Marker || layer instanceof L.Polyline) {
                        map.removeLayer(layer);
                    }
                });
                map.setView([25.0, -80.0], 5);
            }
            
            updateTimeline();
        }
        
        const MULTI_STATE_LANDFALLS = {
            // Florida (complete historical record)
            "FL": [
                // 19th Century (1851-1899)
                {name: "Great Gale", year: 1873, month: 9, day: 19, category: 3, wind_mph: 115, deaths: 5, state: "FL"},
                {name: "Hurricane of 1885", year: 1885, month: 8, day: 25, category: 2, wind_mph: 100, deaths: 15, state: "FL"},
                {name: "Hurricane of 1886", year: 1886, month: 6, day: 21, category: 2, wind_mph: 105, deaths: 10, state: "FL"},
                {name: "Hurricane of 1896", year: 1896, month: 9, day: 29, category: 3, wind_mph: 125, deaths: 130, state: "FL"},
                
                // Early 20th Century (1900-1949)
                {name: "Hurricane of 1906", year: 1906, month: 10, day: 18, category: 3, wind_mph: 120, deaths: 164, state: "FL"},
                {name: "Hurricane of 1909", year: 1909, month: 10, day: 11, category: 3, wind_mph: 110, deaths: 10, state: "FL"},
                {name: "Hurricane of 1910", year: 1910, month: 10, day: 17, category: 3, wind_mph: 115, deaths: 30, state: "FL"},
                {name: "Hurricane of 1919", year: 1919, month: 9, day: 10, category: 4, wind_mph: 150, deaths: 287, state: "FL"},
                {name: "Hurricane of 1921", year: 1921, month: 10, day: 25, category: 3, wind_mph: 120, deaths: 6, state: "FL"},
                {name: "Great Miami", year: 1926, month: 9, day: 18, category: 4, wind_mph: 145, deaths: 372, state: "FL"},
                {name: "San Felipe-Okeechobee", year: 1928, month: 9, day: 16, category: 4, wind_mph: 145, deaths: 2500, state: "FL"},
                {name: "Labor Day", year: 1935, month: 9, day: 2, category: 5, wind_mph: 185, deaths: 408, state: "FL"},
                {name: "Hurricane of 1944", year: 1944, month: 10, day: 19, category: 3, wind_mph: 120, deaths: 18, state: "FL"},
                {name: "Hurricane of 1945", year: 1945, month: 9, day: 15, category: 3, wind_mph: 125, deaths: 4, state: "FL"},
                {name: "Hurricane of 1947", year: 1947, month: 9, day: 17, category: 4, wind_mph: 140, deaths: 51, state: "FL"},
                {name: "Hurricane of 1948", year: 1948, month: 9, day: 21, category: 3, wind_mph: 110, deaths: 3, state: "FL"},
                {name: "Hurricane of 1949", year: 1949, month: 8, day: 26, category: 3, wind_mph: 120, deaths: 2, state: "FL"},
                
                // Modern Era (1950-2024)
                {name: "King", year: 1950, month: 10, day: 18, category: 3, wind_mph: 120, deaths: 3, state: "FL"},
                {name: "Easy", year: 1950, month: 9, day: 5, category: 3, wind_mph: 120, deaths: 2, state: "FL"},
                {name: "Donna", year: 1960, month: 9, day: 10, category: 4, wind_mph: 140, deaths: 50, state: "FL"},
                {name: "Cleo", year: 1964, month: 8, day: 27, category: 2, wind_mph: 100, deaths: 3, state: "FL"},
                {name: "Dora", year: 1964, month: 9, day: 10, category: 2, wind_mph: 110, deaths: 5, state: "FL"},
                {name: "Isbell", year: 1964, month: 10, day: 14, category: 2, wind_mph: 110, deaths: 3, state: "FL"},
                {name: "Betsy", year: 1965, month: 9, day: 8, category: 3, wind_mph: 125, deaths: 5, state: "FL"},
                {name: "Alma", year: 1966, month: 6, day: 9, category: 2, wind_mph: 100, deaths: 6, state: "FL"},
                {name: "Gladys", year: 1968, month: 10, day: 19, category: 2, wind_mph: 100, deaths: 3, state: "FL"},
                {name: "Agnes", year: 1972, month: 6, day: 19, category: 1, wind_mph: 85, deaths: 9, state: "FL"},
                {name: "Eloise", year: 1975, month: 9, day: 23, category: 3, wind_mph: 125, deaths: 21, state: "FL"},
                {name: "David", year: 1979, month: 9, day: 3, category: 2, wind_mph: 95, deaths: 5, state: "FL"},
                {name: "Elena", year: 1985, month: 9, day: 2, category: 3, wind_mph: 125, deaths: 4, state: "FL"},
                {name: "Andrew", year: 1992, month: 8, day: 24, category: 5, wind_mph: 175, deaths: 26, state: "FL"},
                {name: "Opal", year: 1995, month: 10, day: 4, category: 3, wind_mph: 125, deaths: 9, state: "FL"},
                {name: "Charley", year: 2004, month: 8, day: 13, category: 4, wind_mph: 150, deaths: 10, state: "FL"},
                {name: "Frances", year: 2004, month: 9, day: 5, category: 2, wind_mph: 105, deaths: 7, state: "FL"},
                {name: "Jeanne", year: 2004, month: 9, day: 26, category: 3, wind_mph: 120, deaths: 3, state: "FL"},
                {name: "Wilma", year: 2005, month: 10, day: 24, category: 3, wind_mph: 120, deaths: 35, state: "FL"},
                {name: "Irma", year: 2017, month: 9, day: 10, category: 4, wind_mph: 130, deaths: 92, state: "FL"},
                {name: "Michael", year: 2018, month: 10, day: 10, category: 5, wind_mph: 160, deaths: 16, state: "FL"},
                {name: "Ian", year: 2022, month: 9, day: 28, category: 4, wind_mph: 150, deaths: 149, state: "FL"},
                {name: "Idalia", year: 2023, month: 8, day: 30, category: 3, wind_mph: 125, deaths: 8, state: "FL"}
            ],
            
            // Texas (complete historical record)
            "TX": [
                // 19th Century
                {name: "Indianola", year: 1875, month: 9, day: 16, category: 3, wind_mph: 120, deaths: 176, state: "TX"},
                {name: "Indianola", year: 1886, month: 8, day: 20, category: 4, wind_mph: 135, deaths: 74, state: "TX"},
                
                // Early 20th Century
                {name: "Galveston", year: 1900, month: 9, day: 8, category: 4, wind_mph: 145, deaths: 8000, state: "TX"},
                {name: "Hurricane of 1909", year: 1909, month: 7, day: 21, category: 3, wind_mph: 120, deaths: 41, state: "TX"},
                {name: "Hurricane of 1915", year: 1915, month: 8, day: 17, category: 4, wind_mph: 135, deaths: 275, state: "TX"},
                {name: "Hurricane of 1919", year: 1919, month: 9, day: 14, category: 4, wind_mph: 140, deaths: 284, state: "TX"},
                {name: "Hurricane of 1932", year: 1932, month: 8, day: 13, category: 4, wind_mph: 140, deaths: 40, state: "TX"},
                {name: "Hurricane of 1941", year: 1941, month: 9, day: 23, category: 3, wind_mph: 125, deaths: 4, state: "TX"},
                {name: "Hurricane of 1942", year: 1942, month: 8, day: 30, category: 2, wind_mph: 100, deaths: 8, state: "TX"},
                
                // Modern Era
                {name: "Audrey", year: 1957, month: 6, day: 27, category: 4, wind_mph: 145, deaths: 416, state: "TX"},
                {name: "Carla", year: 1961, month: 9, day: 11, category: 4, wind_mph: 145, deaths: 43, state: "TX"},
                {name: "Beulah", year: 1967, month: 9, day: 20, category: 3, wind_mph: 120, deaths: 15, state: "TX"},
                {name: "Celia", year: 1970, month: 8, day: 3, category: 3, wind_mph: 125, deaths: 11, state: "TX"},
                {name: "Allen", year: 1980, month: 8, day: 10, category: 3, wind_mph: 115, deaths: 0, state: "TX"},
                {name: "Alicia", year: 1983, month: 8, day: 18, category: 3, wind_mph: 115, deaths: 21, state: "TX"},
                {name: "Bret", year: 1999, month: 8, day: 22, category: 4, wind_mph: 145, deaths: 0, state: "TX"},
                {name: "Rita", year: 2005, month: 9, day: 24, category: 3, wind_mph: 120, deaths: 120, state: "TX"},
                {name: "Ike", year: 2008, month: 9, day: 13, category: 2, wind_mph: 110, deaths: 112, state: "TX"},
                {name: "Harvey", year: 2017, month: 8, day: 25, category: 4, wind_mph: 130, deaths: 68, state: "TX"},
                {name: "Beryl", year: 2024, month: 7, day: 8, category: 1, wind_mph: 80, deaths: 2, state: "TX"}
            ],
            
            // Louisiana (complete historical record)
            "LA": [
                // 19th Century
                {name: "Last Island", year: 1856, month: 8, day: 10, category: 4, wind_mph: 150, deaths: 400, state: "LA"},
                {name: "Hurricane of 1893", year: 1893, month: 10, day: 2, category: 4, wind_mph: 135, deaths: 2000, state: "LA"},
                
                // Early 20th Century
                {name: "Hurricane of 1909", year: 1909, month: 9, day: 21, category: 4, wind_mph: 135, deaths: 350, state: "LA"},
                {name: "Hurricane of 1915", year: 1915, month: 9, day: 29, category: 4, wind_mph: 145, deaths: 275, state: "LA"},
                {name: "Hurricane of 1918", year: 1918, month: 8, day: 6, category: 3, wind_mph: 120, deaths: 34, state: "LA"},
                {name: "Hurricane of 1947", year: 1947, month: 9, day: 19, category: 3, wind_mph: 115, deaths: 51, state: "LA"},
                
                // Modern Era
                {name: "Audrey", year: 1957, month: 6, day: 27, category: 4, wind_mph: 145, deaths: 416, state: "LA"},
                {name: "Betsy", year: 1965, month: 9, day: 10, category: 3, wind_mph: 125, deaths: 76, state: "LA"},
                {name: "Camille", year: 1969, month: 8, day: 18, category: 5, wind_mph: 175, deaths: 9, state: "LA"},
                {name: "Carmen", year: 1974, month: 9, day: 8, category: 3, wind_mph: 115, deaths: 1, state: "LA"},
                {name: "Juan", year: 1985, month: 10, day: 31, category: 1, wind_mph: 85, deaths: 12, state: "LA"},
                {name: "Andrew", year: 1992, month: 8, day: 26, category: 3, wind_mph: 120, deaths: 15, state: "LA"},
                {name: "Georges", year: 1998, month: 9, day: 28, category: 2, wind_mph: 105, deaths: 6, state: "LA"},
                {name: "Katrina", year: 2005, month: 8, day: 29, category: 3, wind_mph: 125, deaths: 1833, state: "LA"},
                {name: "Rita", year: 2005, month: 9, day: 24, category: 3, wind_mph: 120, deaths: 7, state: "LA"},
                {name: "Gustav", year: 2008, month: 9, day: 1, category: 2, wind_mph: 110, deaths: 53, state: "LA"},
                {name: "Isaac", year: 2012, month: 8, day: 29, category: 1, wind_mph: 80, deaths: 7, state: "LA"},
                {name: "Laura", year: 2020, month: 8, day: 27, category: 4, wind_mph: 150, deaths: 42, state: "LA"},
                {name: "Ida", year: 2021, month: 8, day: 29, category: 4, wind_mph: 150, deaths: 95, state: "LA"}
            ],
            
            // Mississippi (complete historical record)
            "MS": [
                // 19th Century
                {name: "Hurricane of 1860", year: 1860, month: 8, day: 11, category: 3, wind_mph: 115, deaths: 40, state: "MS"},
                {name: "Hurricane of 1893", year: 1893, month: 10, day: 2, category: 3, wind_mph: 120, deaths: 100, state: "MS"},
                
                // Early 20th Century
                {name: "Hurricane of 1906", year: 1906, month: 9, day: 27, category: 3, wind_mph: 115, deaths: 134, state: "MS"},
                {name: "Hurricane of 1909", year: 1909, month: 9, day: 20, category: 3, wind_mph: 120, deaths: 25, state: "MS"},
                {name: "Hurricane of 1916", year: 1916, month: 7, day: 5, category: 3, wind_mph: 120, deaths: 10, state: "MS"},
                {name: "Hurricane of 1947", year: 1947, month: 9, day: 19, category: 3, wind_mph: 115, deaths: 22, state: "MS"},
                
                // Modern Era
                {name: "Camille", year: 1969, month: 8, day: 18, category: 5, wind_mph: 175, deaths: 259, state: "MS"},
                {name: "Frederic", year: 1979, month: 9, day: 13, category: 3, wind_mph: 130, deaths: 5, state: "MS"},
                {name: "Elena", year: 1985, month: 9, day: 2, category: 3, wind_mph: 115, deaths: 1, state: "MS"},
                {name: "Georges", year: 1998, month: 9, day: 28, category: 2, wind_mph: 105, deaths: 1, state: "MS"},
                {name: "Katrina", year: 2005, month: 8, day: 29, category: 3, wind_mph: 120, deaths: 238, state: "MS"},
                {name: "Isaac", year: 2012, month: 8, day: 29, category: 1, wind_mph: 80, deaths: 1, state: "MS"},
                {name: "Nate", year: 2017, month: 10, day: 8, category: 1, wind_mph: 85, deaths: 0, state: "MS"},
                {name: "Zeta", year: 2020, month: 10, day: 28, category: 2, wind_mph: 110, deaths: 1, state: "MS"}
            ],
            
            // Alabama  
            "AL": [
                {name: "Frederic", year: 1979, month: 9, day: 13, category: 3, wind_mph: 130, deaths: 5, state: "AL"},
                {name: "Elena", year: 1985, month: 9, day: 2, category: 3, wind_mph: 115, deaths: 4, state: "AL"},
                {name: "Danny", year: 1997, month: 7, day: 19, category: 1, wind_mph: 80, deaths: 4, state: "AL"},
                {name: "Georges", year: 1998, month: 9, day: 28, category: 2, wind_mph: 105, deaths: 1, state: "AL"},
                {name: "Ivan", year: 2004, month: 9, day: 16, category: 3, wind_mph: 120, deaths: 25, state: "AL"},
                {name: "Katrina", year: 2005, month: 8, day: 29, category: 3, wind_mph: 125, deaths: 2, state: "AL"},
                {name: "Sally", year: 2020, month: 9, day: 16, category: 2, wind_mph: 105, deaths: 4, state: "AL"},
                {name: "Zeta", year: 2020, month: 10, day: 28, category: 2, wind_mph: 110, deaths: 3, state: "AL"}
            ],
            
            // North Carolina (complete historical record)
            "NC": [
                // 19th Century
                {name: "Hurricane of 1879", year: 1879, month: 8, day: 18, category: 3, wind_mph: 115, deaths: 40, state: "NC"},
                {name: "Hurricane of 1883", year: 1883, month: 9, day: 11, category: 2, wind_mph: 100, deaths: 53, state: "NC"},
                {name: "Hurricane of 1893", year: 1893, month: 8, day: 27, category: 3, wind_mph: 120, deaths: 25, state: "NC"},
                {name: "Hurricane of 1899", year: 1899, month: 10, day: 31, category: 3, wind_mph: 115, deaths: 20, state: "NC"},
                
                // Early 20th Century
                {name: "Hurricane of 1933", year: 1933, month: 9, day: 16, category: 3, wind_mph: 125, deaths: 21, state: "NC"},
                {name: "Hurricane of 1944", year: 1944, month: 9, day: 14, category: 3, wind_mph: 120, deaths: 3, state: "NC"},
                
                // Modern Era
                {name: "Hazel", year: 1954, month: 10, day: 15, category: 4, wind_mph: 140, deaths: 19, state: "NC"},
                {name: "Connie", year: 1955, month: 8, day: 12, category: 3, wind_mph: 115, deaths: 25, state: "NC"},
                {name: "Diane", year: 1955, month: 8, day: 17, category: 1, wind_mph: 85, deaths: 77, state: "NC"},
                {name: "Ione", year: 1955, month: 9, day: 19, category: 3, wind_mph: 115, deaths: 7, state: "NC"},
                {name: "Donna", year: 1960, month: 9, day: 12, category: 3, wind_mph: 115, deaths: 8, state: "NC"},
                {name: "Diana", year: 1984, month: 9, day: 13, category: 2, wind_mph: 100, deaths: 3, state: "NC"},
                {name: "Gloria", year: 1985, month: 9, day: 27, category: 2, wind_mph: 105, deaths: 8, state: "NC"},
                {name: "Hugo", year: 1989, month: 9, day: 22, category: 2, wind_mph: 105, deaths: 7, state: "NC"},
                {name: "Bertha", year: 1996, month: 7, day: 12, category: 2, wind_mph: 105, deaths: 12, state: "NC"},
                {name: "Fran", year: 1996, month: 9, day: 6, category: 3, wind_mph: 115, deaths: 37, state: "NC"},
                {name: "Floyd", year: 1999, month: 9, day: 16, category: 2, wind_mph: 105, deaths: 57, state: "NC"},
                {name: "Isabel", year: 2003, month: 9, day: 18, category: 2, wind_mph: 105, deaths: 32, state: "NC"},
                {name: "Florence", year: 2018, month: 9, day: 14, category: 1, wind_mph: 90, deaths: 54, state: "NC"},
                {name: "Dorian", year: 2019, month: 9, day: 6, category: 1, wind_mph: 90, deaths: 4, state: "NC"}
            ],
            
            // South Carolina
            "SC": [
                {name: "Hugo", year: 1989, month: 9, day: 22, category: 4, wind_mph: 140, deaths: 35, state: "SC"},
                {name: "Gaston", year: 2004, month: 8, day: 29, category: 1, wind_mph: 75, deaths: 8, state: "SC"},
                {name: "Matthew", year: 2016, month: 10, day: 8, category: 1, wind_mph: 75, deaths: 4, state: "SC"},
                {name: "Florence", year: 2018, month: 9, day: 14, category: 1, wind_mph: 90, deaths: 9, state: "SC"}
            ],
            
            // Georgia
            "GA": [
                {name: "David", year: 1979, month: 9, day: 4, category: 1, wind_mph: 90, deaths: 5, state: "GA"},
                {name: "Matthew", year: 2016, month: 10, day: 8, category: 1, wind_mph: 75, deaths: 3, state: "GA"}
            ],
            
            // Other states would have minimal data for this time period
            "VA": [],
            "MD": [],
            "DE": [],
            "NJ": [],
            "NY": [],
            "CT": [],
            "RI": [],
            "MA": [],
            "NH": [],
            "ME": []
        };
        
        let selectedStates = ['FL'];
        let currentStartYear = 2010;
        let currentEndYear = 2024;
        
        function getCategoryColor(category) {
            const colors = {
                1: "#5CB85C",   // Cat 1 - Green
                2: "#F0AD4E",   // Cat 2 - Yellow-Orange
                3: "#FF7F00",   // Cat 3 - Orange
                4: "#D9534F",   // Cat 4 - Red
                5: "#8B008B"    // Cat 5 - Dark Magenta
            };
            return colors[category] || "#757575";
        }
        
        function getStateColor(state) {
            const colors = {
                'FL': '#e74c3c', 'TX': '#3498db', 'LA': '#9b59b6', 'NC': '#f39c12',
                'SC': '#2ecc71', 'GA': '#e67e22', 'AL': '#1abc9c', 'MS': '#34495e',
                'VA': '#e91e63', 'MD': '#795548', 'DE': '#607d8b', 'NJ': '#ff5722',
                'NY': '#9c27b0', 'CT': '#00bcd4', 'RI': '#4caf50', 'MA': '#ff9800',
                'NH': '#8bc34a', 'ME': '#cddc39'
            };
            return colors[state] || '#95a5a6';
        }
        
        function toggleDropdown() {
            const dropdown = document.getElementById('state-dropdown');
            dropdown.classList.toggle('show');
        }
        
        function selectGroup(region) {
            const gulfStates = ['FL', 'TX', 'LA', 'MS', 'AL'];
            const atlanticStates = ['FL', 'GA', 'SC', 'NC', 'VA', 'MD', 'DE', 'NJ', 'NY', 'CT', 'RI', 'MA', 'NH', 'ME'];
            
            const statesToToggle = region === 'gulf' ? gulfStates : atlanticStates;
            const groupCheckbox = document.getElementById(region === 'gulf' ? 'SELECT_GULF' : 'SELECT_ATLANTIC');
            const isChecking = groupCheckbox.checked;
            
            statesToToggle.forEach(state => {
                const checkbox = document.getElementById(state);
                if (checkbox) {
                    checkbox.checked = isChecking;
                }
            });
            
            updateSelection();
        }
        
        function updateSelection() {
            const checkboxes = document.querySelectorAll('#state-dropdown input[type="checkbox"]:not([value="SELECT_GULF"]):not([value="SELECT_ATLANTIC"])');
            selectedStates = Array.from(checkboxes).filter(cb => cb.checked).map(cb => cb.value);
            
            const stateNames = {
                'FL': 'Florida', 'TX': 'Texas', 'LA': 'Louisiana', 'NC': 'North Carolina',
                'SC': 'South Carolina', 'GA': 'Georgia', 'AL': 'Alabama', 'MS': 'Mississippi',
                'VA': 'Virginia', 'MD': 'Maryland', 'DE': 'Delaware', 'NJ': 'New Jersey',
                'NY': 'New York', 'CT': 'Connecticut', 'RI': 'Rhode Island', 'MA': 'Massachusetts',
                'NH': 'New Hampshire', 'ME': 'Maine'
            };
            
            const displayText = selectedStates.length === 0 ? 'No states selected' :
                               selectedStates.length === 1 ? stateNames[selectedStates[0]] :
                               selectedStates.length <= 3 ? selectedStates.map(s => stateNames[s]).join(', ') :
                               `${selectedStates.length} states selected`;
                               
            document.getElementById('selected-display').textContent = displayText;
            document.getElementById('states-summary').textContent = 
                `${selectedStates.length} state${selectedStates.length !== 1 ? 's' : ''} selected`;
        }
        
        function updateTimeline() {
            currentStartYear = parseInt(document.getElementById('start-year').value);
            currentEndYear = parseInt(document.getElementById('end-year').value);
            
            if (selectedStates.length === 0) {
                alert('Please select at least one state to display data.');
                return;
            }
            
            createMultiStateTimeline();
            document.getElementById('state-dropdown').classList.remove('show');
        }
        
        function createMultiStateTimeline() {
            const yearSpan = currentEndYear - currentStartYear + 1;
            const years = Array.from({length: yearSpan}, (_, i) => currentStartYear + i);
            const months = [6, 7, 8, 9, 10, 11];
            const monthNames = {6: "Jun", 7: "Jul", 8: "Aug", 9: "Sep", 10: "Oct", 11: "Nov"};
            const daysInMonth = {6: 30, 7: 31, 8: 31, 9: 30, 10: 31, 11: 30};
            
            const traces = [];
            const shapes = [];
            const annotations = [];
            
            // Calculate responsive font sizes
            const width = window.innerWidth;
            const baseFontSize = width < 768 ? 14 : width < 1200 ? 18 : 20;
            const titleFontSize = width < 768 ? 24 : width < 1200 ? 28 : 32;
            
            // Add year labels (every 5 years for longer timelines)
            const yearInterval = yearSpan > 30 ? 10 : 5;
            years.forEach((year, i) => {
                if (year % yearInterval === 0) {
                    annotations.push({
                        x: -0.7,
                        y: i,
                        text: `${year}`,
                        showarrow: false,
                        xanchor: 'right',
                        font: {size: baseFontSize, color: '#2C3E50', family: 'Arial'}
                    });
                }
                
                if (year % 10 === 0) {
                    shapes.push({
                        type: 'line',
                        x0: -0.5, x1: 6,
                        y0: i, y1: i,
                        line: {color: 'rgba(189, 195, 199, 0.7)', width: 1},
                        layer: 'below'
                    });
                }
                
                // Add vertical month boundary lines
                if (i === 0) {
                    months.forEach((month, j) => {
                        if (j > 0) {
                            shapes.push({
                                type: 'line',
                                x0: j, x1: j,
                                y0: -0.5, y1: years.length - 0.5,
                                line: {color: 'rgba(189, 195, 199, 0.7)', width: 1},
                                layer: 'below'
                            });
                        }
                    });
                }
            });
            
            // Create trace using ATLANTIC_STORMS_ENHANCED data with FILTERING (same as timeline tab)
            const allStorms = ATLANTIC_STORMS_ENHANCED.filter(storm => {
                const isSelectedState = selectedStates.some(state => 
                    storm.landfall_states && storm.landfall_states.includes(state)
                );
                const inYearRange = storm.year >= currentStartYear && storm.year <= currentEndYear;
                
                if (!isSelectedState || !inYearRange) return false;
                
                // Apply active filters (same logic as updateStats)
                const nameFilter = document.getElementById('nameFilter') ? document.getElementById('nameFilter').value.toLowerCase() : '';
                const landfallOnly = document.getElementById('landfallOnly') ? document.getElementById('landfallOnly').checked : false;
                
                // Get selected categories from checkboxes
                const selectedCategories = [];
                const categoryCheckboxes = document.querySelectorAll('#categoryFilter input[type="checkbox"]:checked');
                categoryCheckboxes.forEach(checkbox => {
                    selectedCategories.push(parseInt(checkbox.value));
                });
                
                // If name search is active, ONLY filter by name - ignore all other filters
                if (nameFilter) {
                    return storm.name.toLowerCase().includes(nameFilter);
                }
                
                // Otherwise apply normal filters
                if (selectedCategories.length > 0 && !selectedCategories.includes(storm.category)) return false;
                // Only show hurricane season months (Jun-Dec: months 6-12)
                if (storm.month < 6 || storm.month > 12) return false;
                // Filter for landfall storms if checkbox is checked
                if (landfallOnly && !isLikelyUSLandfall(storm)) return false;
                return true;
            });
            
            console.log(`Creating plot with ${allStorms.length} storms from ATLANTIC_STORMS_ENHANCED`);
            
            if (allStorms.length > 0) {
                const trace = {
                    x: [],
                    y: [],
                    text: [],
                    customdata: [],
                    marker: {
                        size: [],
                        color: [],
                        line: {color: 'white', width: 2},
                        opacity: 0.8
                    },
                    name: 'Hurricanes',
                    mode: 'markers+text',
                    type: 'scatter',
                    textposition: 'top center',
                    textfont: {size: 14, color: '#2C3E50', family: 'Arial', weight: 'bold'},
                    hovertemplate: '<b style="font-size:20px">%{customdata[0]}</b><br>' +
                                  '<b>Year:</b> %{customdata[1]}<br>' +
                                  '<b>Category:</b> %{customdata[2]}<br>' +
                                  '<b>Wind Speed:</b> %{customdata[3]} mph<br>' +
                                  '<b>States:</b> %{customdata[4]}<br>' +
                                  '<i>Click for details</i><br>' +
                                  '<extra></extra>'
                };
                
                allStorms.forEach(storm => {
                    const yearIdx = years.indexOf(storm.year);
                    if (yearIdx === -1) return;
                    
                    const monthIdx = months.indexOf(storm.month);
                    if (monthIdx === -1) return;
                    
                    const xPos = monthIdx + (storm.day - 1) / daysInMonth[storm.month];
                    
                    trace.x.push(xPos);
                    trace.y.push(yearIdx);
                    trace.text.push(yearSpan > 50 ? '' : storm.name);
                    trace.marker.size.push(Math.max(10, 12.5 + storm.wind_mph / 8));
                    trace.marker.color.push(getCategoryColor(storm.category));
                    trace.customdata.push([
                        storm.name,
                        storm.year,
                        `Category ${storm.category}`,
                        storm.wind_mph,
                        storm.landfall_states ? storm.landfall_states.join(', ') : 'N/A'
                    ]);
                });
                
                traces.push(trace);
            }
            
            const layout = {
                title: {
                    text: `<b>Multi-State Hurricane Landfalls (${currentStartYear}-${currentEndYear})</b>`,
                    x: 0.5,
                    xanchor: 'center',
                    font: {size: titleFontSize, color: '#2C3E50', family: 'Arial'}
                },
                xaxis: {
                    tickmode: 'array',
                    tickvals: [0.5, 1.5, 2.5, 3.5, 4.5, 5.5],
                    ticktext: ['June', 'July', 'August', 'September', 'October', 'November'],
                    range: [-1, 6.2],
                    showgrid: false,
                    zeroline: false,
                    tickfont: {size: baseFontSize, color: '#2C3E50'}
                },
                yaxis: {
                    showticklabels: false,
                    range: [-0.5, years.length - 0.5],
                    showgrid: false,
                    zeroline: false,
                    autorange: 'reversed'
                },
                autosize: true,
                plot_bgcolor: '#FAFAFA',
                paper_bgcolor: 'white',
                hovermode: 'closest',
                hoverlabel: {
                    bgcolor: 'white',
                    font: {size: 16, family: 'Arial'}
                },
                legend: {
                    title: {text: '<b>States</b> <span style="font-weight: normal; font-size: smaller;">(click to toggle)</span>', font: {size: baseFontSize}},
                    orientation: 'h',
                    yanchor: 'bottom',
                    y: -0.15,
                    xanchor: 'center',
                    x: 0.5,
                    bgcolor: 'rgba(255,255,255,0.95)',
                    bordercolor: '#BDC3C7',
                    borderwidth: 1,
                    font: {size: baseFontSize - 2}
                },
                margin: {l: 60, r: 40, t: 80, b: 120},
                shapes: shapes,
                annotations: annotations
            };
            
            const config = {
                responsive: true,
                displayModeBar: true,
                displaylogo: false,
                modeBarButtonsToRemove: ['pan2d', 'select2d', 'lasso2d', 'autoScale2d'],
                toImageButtonOptions: {
                    scale: 2
                }
            };
            
            Plotly.newPlot('timeline', traces, layout, config).then(function(myPlot) {
                console.log('Timeline created, attaching click handler...');
                
                // Add click handler for timeline
                myPlot.on('plotly_click', function(data) {
                    const point = data.points[0];
                    const pointIndex = point.pointIndex;
                    console.log(`=== MULTI-STATE CLICK HANDLER ===`);
                    console.log(`Point index: ${pointIndex}`);
                    
                    // CRITICAL FIX: Apply the EXACT SAME filters as plot creation to avoid index mismatch
                    const nameFilter = document.getElementById('nameFilter') ? document.getElementById('nameFilter').value.toLowerCase() : '';
                    const landfallOnly = document.getElementById('landfallOnly') ? document.getElementById('landfallOnly').checked : false;
                    
                    // Get selected categories from checkboxes
                    const selectedCategories = [];
                    const categoryCheckboxes = document.querySelectorAll('#categoryFilter input[type="checkbox"]:checked');
                    categoryCheckboxes.forEach(checkbox => {
                        selectedCategories.push(parseInt(checkbox.value));
                    });
                    
                    const allStorms = ATLANTIC_STORMS_ENHANCED.filter(storm => {
                        const isSelectedState = selectedStates.some(state => 
                            storm.landfall_states && storm.landfall_states.includes(state)
                        );
                        const inYearRange = storm.year >= currentStartYear && storm.year <= currentEndYear;
                        
                        if (!isSelectedState || !inYearRange) return false;
                        
                        // If name search is active, ONLY filter by name
                        if (nameFilter) {
                            return storm.name.toLowerCase().includes(nameFilter);
                        }
                        
                        // Otherwise apply normal filters (same as plot creation)
                        if (selectedCategories.length > 0 && !selectedCategories.includes(storm.category)) return false;
                        if (storm.month < 6 || storm.month > 12) return false;
                        if (landfallOnly && !isLikelyUSLandfall(storm)) return false;
                        return true;
                    });
                    
                    console.log(`Filtered storms count: ${allStorms.length}`);
                    console.log(`Selected storm:`, allStorms[pointIndex]);
                    
                    const storm = allStorms[pointIndex];
                    if (storm) {
                        console.log(`Storm ID: "${storm.storm_id}", Name: "${storm.name}"`);
                        updateStormInfoPanel(storm);
                        showStormOnMap(storm);
                    } else {
                        console.log('No storm found at index', pointIndex);
                    }
                });
            });
            updateStats();
        }
        
        function updateStats() {
            // Use ATLANTIC_STORMS_ENHANCED data with same filtering logic as plot
            const filteredStorms = ATLANTIC_STORMS_ENHANCED.filter(storm => {
                const isSelectedState = selectedStates.some(state => 
                    storm.landfall_states && storm.landfall_states.includes(state)
                );
                const inYearRange = storm.year >= currentStartYear && storm.year <= currentEndYear;
                
                if (!isSelectedState || !inYearRange) return false;
                
                // Apply active filters
                const nameFilter = document.getElementById('nameFilter').value.toLowerCase();
                const landfallOnly = document.getElementById('landfallOnly').checked;
                
                // Get selected categories from checkboxes
                const selectedCategories = [];
                const categoryCheckboxes = document.querySelectorAll('#categoryFilter input[type="checkbox"]:checked');
                categoryCheckboxes.forEach(checkbox => {
                    selectedCategories.push(parseInt(checkbox.value));
                });
                
                // If name search is active, ONLY filter by name - ignore all other filters
                if (nameFilter) {
                    return storm.name.toLowerCase().includes(nameFilter);
                }
                
                // Otherwise apply normal filters
                if (selectedCategories.length > 0 && !selectedCategories.includes(storm.category)) return false;
                // Only show hurricane season months (Jun-Dec: months 6-12)
                if (storm.month < 6 || storm.month > 12) return false;
                // Filter for landfall storms if checkbox is checked
                if (landfallOnly && !isLikelyUSLandfall(storm)) return false;
                return true;
            });
            
            const totalStorms = filteredStorms.length;
            const majorHurricanes = filteredStorms.filter(s => s.category >= 3).length;
            const totalDeaths = filteredStorms.reduce((sum, s) => sum + (s.deaths || 0), 0);
            
            const stateNames = selectedStates.length === 1 ? 
                selectedStates[0] : 
                `${selectedStates.length} selected states`;
                
            document.getElementById('stats-text').innerHTML = 
                `<strong>${totalStorms} hurricane landfalls</strong> across ${stateNames} (${currentStartYear}-${currentEndYear}), including <strong>${majorHurricanes} major hurricanes</strong> (Category 3+), resulting in <strong>${totalDeaths.toLocaleString()} deaths</strong>.`;
        }
        
        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.multi-select')) {
                document.getElementById('state-dropdown').classList.remove('show');
            }
        });
        
        // Close modal
        document.querySelector('.close').onclick = function() {
            document.getElementById('stormModal').style.display = 'none';
        }
        
        // Add the missing updateTimeline function
        function updateTimeline() {
            currentStartYear = parseInt(document.getElementById('start-year').value);
            currentEndYear = parseInt(document.getElementById('end-year').value);
            
            if (selectedStates.length > 0) {
                Plotly.purge('timeline');
                createMultiStateTimeline();
                updateStats();
            }
        }
        
        // Note: The actual createMultiStateTimeline function is already defined above (line 1259)
        // This was just a placeholder - removing the duplicate
        
        function getCategoryColor(category) {
            const colors = {
                0: "#8B9DC3", 1: "#5CB85C", 2: "#F0AD4E", 
                3: "#FF7F00", 4: "#D9534F", 5: "#8B008B"
            };
            return colors[category] || "#757575";
        }
        
        function getMonthName(month) {
            const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
            return months[month-1];
        }
        
        function isLikelyUSLandfall(storm) {
            if (storm.landfall_states && storm.landfall_states.length > 0) {
                return true;
            }
            if (storm.lat && storm.lon) {
                return storm.lat > 25 && storm.lon > -100 && storm.lon < -65;
            }
            return false;
        }
        
        function updateStormInfoPanel(storm) {
            // Update category icon
            const categoryIcon = document.getElementById('categoryIcon');
            const color = getCategoryColor(storm.category);
            categoryIcon.style.backgroundColor = color;
            categoryIcon.textContent = storm.category === 0 ? 'TS' : `C${storm.category}`;
            
            // Update storm title
            document.getElementById('stormTitle').textContent = `${storm.name} (${storm.year})`;
            
            // Update stats
            document.getElementById('statDate').textContent = `${getMonthName(storm.month)} ${storm.day}`;
            document.getElementById('statWind').textContent = `${storm.wind_mph} mph`;
            document.getElementById('statLandfall').textContent = storm.landfall_states && storm.landfall_states.length > 0 
                ? storm.landfall_states.join(', ') 
                : 'None';
            document.getElementById('statDeaths').textContent = storm.deaths || '0';
            
            // Update narrative panel
            const narrativeContent = document.getElementById('narrativeContent');
            if (storm.narrative) {
                narrativeContent.innerHTML = `<p style="line-height: 1.6; color: #333;">${storm.narrative}</p>`;
            } else {
                narrativeContent.innerHTML = `<p style="color: #666; font-style: italic;">No historical narrative available for this storm.</p>`;
            }
        }
        
        async function showStormOnMap(storm) {
            if (!map) return;
            
            clearMapLayers();
            console.log('=== STORM DEBUG INFO ===');
            console.log('Storm object:', storm);
            console.log('Storm name:', storm.name);
            console.log('Storm year:', storm.year);
            console.log('Storm ID:', storm.storm_id);
            
            // Try to load the full storm track
            const trackData = await loadStormTrack(storm);
            
            if (trackData) {
                console.log('Track data loaded, drawing storm track');
                drawStormTrack(trackData, storm);
            } else {
                console.log('No track data found, showing single point');
                if (storm.lat && storm.lon) {
                    const color = getCategoryColor(storm.category);
                    L.circleMarker([storm.lat, storm.lon], {
                        color: color,
                        fillColor: color,
                        fillOpacity: 0.7,
                        radius: 8
                    }).addTo(map).bindPopup(`<b>${storm.name}</b><br>Category ${storm.category}<br>${storm.wind_mph} mph`);
                    
                    map.setView([storm.lat, storm.lon], 6);
                }
            }
        }
        
        async function loadStormTrack(storm) {
            try {
                const decade = Math.floor(storm.year / 10) * 10;
                const pointsFile = `./hurdat2_data/points_${decade}s.geojson`;
                console.log(`Loading track from: ${pointsFile}`);
                console.log(`Looking for storm_id: "${storm.storm_id}"`);
                
                let pointsResponse = await fetch(pointsFile);
                if (pointsResponse.ok) {
                    const pointsData = await pointsResponse.json();
                    const pointFeatures = pointsData.features.filter(f => 
                        f.properties.storm_id === storm.storm_id
                    );
                    
                    console.log(`Found ${pointFeatures.length} track points`);
                    if (pointFeatures.length > 0) {
                        return { type: 'points', features: pointFeatures };
                    }
                }
                
                // Fallback to tracks file
                const tracksFile = `./hurdat2_data/tracks_${decade}s.geojson`;
                let tracksResponse = await fetch(tracksFile);
                if (tracksResponse.ok) {
                    const tracksData = await tracksResponse.json();
                    const trackFeature = tracksData.features.find(f => 
                        f.properties.storm_id === storm.storm_id
                    );
                    
                    if (trackFeature) {
                        return { type: 'track', geometry: trackFeature.geometry };
                    }
                }
            } catch (error) {
                console.error('Error loading storm track:', error);
            }
            return null;
        }
        
        function drawStormTrack(trackData, storm) {
            if (trackData.type === 'points') {
                drawRainbowTrack(trackData.features, storm);
            } else if (trackData.type === 'track') {
                drawSimpleTrack(trackData.geometry, storm);
            }
        }
        
        function drawRainbowTrack(pointFeatures, storm) {
            console.log(`Drawing RAINBOW track with ${pointFeatures.length} points for ${storm.name}`);
            
            // Sort points by time
            pointFeatures.sort((a, b) => {
                if (a.properties.datetime && b.properties.datetime) {
                    return new Date(a.properties.datetime) - new Date(b.properties.datetime);
                }
                return 0;
            });
            
            const allLatLngs = [];
            
            // Draw colored line segments
            for (let i = 0; i < pointFeatures.length - 1; i++) {
                const point1 = pointFeatures[i];
                const point2 = pointFeatures[i + 1];
                
                const coord1 = point1.geometry.coordinates;
                const coord2 = point2.geometry.coordinates;
                
                // Calculate category from wind speed
                const maxWind = point1.properties.max_wind || 0;
                let category = 0;
                if (maxWind >= 137) category = 5;
                else if (maxWind >= 113) category = 4;
                else if (maxWind >= 96) category = 3;
                else if (maxWind >= 83) category = 2;
                else if (maxWind >= 64) category = 1;
                else category = 0;
                
                const latLng1 = [coord1[1], coord1[0]];
                const latLng2 = [coord2[1], coord2[0]];
                
                allLatLngs.push(latLng1);
                if (i === pointFeatures.length - 2) allLatLngs.push(latLng2);
                
                const segmentColor = getCategoryColor(category);
                
                L.polyline([latLng1, latLng2], {
                    color: segmentColor,
                    weight: 6,
                    opacity: 1.0
                }).addTo(map);
            }
            
            // Fit map to track bounds
            if (allLatLngs.length > 0) {
                const bounds = L.latLngBounds(allLatLngs);
                map.fitBounds(bounds, { 
                    padding: [20, 20],
                    maxZoom: 8
                });
            }
        }
        
        function drawSimpleTrack(trackGeometry, storm) {
            const coordinates = trackGeometry.coordinates;
            const trackPoints = coordinates.map(coord => [coord[1], coord[0]]);
            
            const trackLine = L.polyline(trackPoints, {
                color: getCategoryColor(storm.category),
                weight: 4,
                opacity: 0.8
            }).addTo(map);
            
            // Add start and end markers
            if (trackPoints.length > 0) {
                L.circleMarker(trackPoints[0], {
                    color: '#00ff00',
                    fillColor: '#00ff00',
                    fillOpacity: 0.8,
                    radius: 8
                }).addTo(map).bindPopup(`<b>${storm.name} START</b><br>${storm.year}`);
                
                L.circleMarker(trackPoints[trackPoints.length - 1], {
                    color: '#ff0000',
                    fillColor: '#ff0000',
                    fillOpacity: 0.8,
                    radius: 8
                }).addTo(map).bindPopup(`<b>${storm.name} END</b><br>${storm.year}`);
            }
            
            map.fitBounds(trackLine.getBounds(), { 
                padding: [20, 20],
                maxZoom: 8
            });
        }
        
        function clearMapLayers() {
            if (map) {
                map.eachLayer(function (layer) {
                    if (layer instanceof L.CircleMarker || layer instanceof L.Polyline) {
                        map.removeLayer(layer);
                    }
                });
            }
        }
        
        // Initialize map on page load
        document.addEventListener('DOMContentLoaded', () => {
            initMap();
            // Apply initial filters to show storm markers
            setTimeout(() => {
                applyFilters();
            }, 500);
        });
        
        // Recreate on window resize
        let resizeTimeout;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                if (selectedStates.length > 0) {
                    Plotly.purge('timeline');
                    createMultiStateTimeline();
                }
            }, 500);
        });
    </script>
</body>
</html>