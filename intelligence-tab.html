<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hurricane Intelligence - Red Cross Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="atlantic-storms-enhanced.js"></script>
    <style>
        :root {
            --rc-red: #ED1B2E;
            --rc-dark-red: #B71234;
        }
        
        .comparison-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            height: 100%;
        }
        
        .storm-metric {
            padding: 8px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .storm-metric:last-child {
            border-bottom: none;
        }
        
        .impact-meter {
            height: 30px;
            background: #e5e7eb;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }
        
        .impact-fill {
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 10px;
            color: white;
            font-weight: bold;
            transition: width 1s ease;
        }
        
        .tcr-button {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: #10b981;
            color: white;
            border-radius: 6px;
            text-decoration: none;
            transition: all 0.2s;
        }
        
        .tcr-button:hover {
            background: #059669;
            transform: translateY(-2px);
        }
        
        .pattern-match {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px;
            border-radius: 8px;
            margin: 8px 0;
        }
        
        .prediction-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
        }
        
        .similar-storm {
            background: #f9fafb;
            padding: 12px;
            border-radius: 8px;
            margin: 8px 0;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .similar-storm:hover {
            background: #f3f4f6;
            transform: translateX(4px);
        }
        
        .match-score {
            display: inline-block;
            padding: 4px 8px;
            background: #fbbf24;
            color: #78350f;
            border-radius: 20px;
            font-weight: bold;
            font-size: 12px;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <div class="bg-white shadow-md border-b-4 border-red-600">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex items-center">
                <div class="w-12 h-12 bg-red-600 rounded-full flex items-center justify-center text-white font-bold mr-4">RC</div>
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">Hurricane Intelligence Center</h1>
                    <p class="text-sm text-gray-600">Advanced Analysis & Tropical Cyclone Reports</p>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 py-6">
        <!-- Storm Selector -->
        <div class="bg-white rounded-lg shadow-md p-4 mb-6">
            <h2 class="text-lg font-bold mb-4">Storm Analysis</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Primary Storm</label>
                    <select id="storm1Select" class="w-full px-3 py-2 border rounded-lg" onchange="selectStorm(1)">
                        <option value="">Select a storm...</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Compare With</label>
                    <select id="storm2Select" class="w-full px-3 py-2 border rounded-lg" onchange="selectStorm(2)">
                        <option value="">Select a storm...</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Compare With</label>
                    <select id="storm3Select" class="w-full px-3 py-2 border rounded-lg" onchange="selectStorm(3)">
                        <option value="">Select a storm...</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Comparison View -->
        <div id="comparisonView" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
            <!-- Storm 1 Card -->
            <div class="comparison-card" id="storm1Card">
                <div class="text-center text-gray-500 py-8">
                    <svg class="w-16 h-16 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                    </svg>
                    <p>Select a storm to analyze</p>
                </div>
            </div>

            <!-- Storm 2 Card -->
            <div class="comparison-card" id="storm2Card">
                <div class="text-center text-gray-500 py-8">
                    <svg class="w-16 h-16 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                    </svg>
                    <p>Select a storm to compare</p>
                </div>
            </div>

            <!-- Storm 3 Card -->
            <div class="comparison-card" id="storm3Card">
                <div class="text-center text-gray-500 py-8">
                    <svg class="w-16 h-16 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                    </svg>
                    <p>Select a storm to compare</p>
                </div>
            </div>
        </div>

        <!-- Pattern Matching -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6" id="patternSection" style="display: none;">
            <h2 class="text-xl font-bold mb-4">Similar Historical Storms</h2>
            <div id="similarStormsList">
                <!-- Similar storms will be populated here -->
            </div>
        </div>

        <!-- Impact Prediction -->
        <div class="prediction-card" id="predictionSection" style="display: none;">
            <h2 class="text-2xl font-bold mb-4">Red Cross Resource Prediction</h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="text-center">
                    <div class="text-3xl font-bold" id="predictedShelters">-</div>
                    <div class="text-sm opacity-90">Shelters Needed</div>
                </div>
                <div class="text-center">
                    <div class="text-3xl font-bold" id="predictedMeals">-</div>
                    <div class="text-sm opacity-90">Meals Required</div>
                </div>
                <div class="text-center">
                    <div class="text-3xl font-bold" id="predictedVolunteers">-</div>
                    <div class="text-sm opacity-90">Volunteers</div>
                </div>
                <div class="text-center">
                    <div class="text-3xl font-bold" id="predictedCost">-</div>
                    <div class="text-sm opacity-90">Est. Cost</div>
                </div>
            </div>
        </div>

        <!-- TCR Viewer -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6" id="tcrSection" style="display: none;">
            <h2 class="text-xl font-bold mb-4">Tropical Cyclone Reports</h2>
            <div id="tcrLinks" class="flex flex-wrap gap-4">
                <!-- TCR links will be populated here -->
            </div>
            <div id="tcrViewer" class="mt-4">
                <!-- PDF viewer will go here -->
            </div>
        </div>

        <!-- Comparison Charts - Full Width -->
        <!-- Spider/Radar Chart -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-bold mb-4">Multi-Factor Spider Chart</h2>
            <div id="comparisonChart" style="height: 650px;"></div>
        </div>
        
        <!-- Scatter Plot -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-bold mb-4">Wind vs Pressure Analysis</h2>
            <p class="text-sm text-gray-600 mb-2">üí° Click any gray dot to add that storm to comparison</p>
            <div id="scatterChart" style="height: 650px;"></div>
        </div>
        
        <!-- Time Series -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-bold mb-4">Historical Intensity Trend</h2>
            <p class="text-sm text-gray-600 mb-2">üí° Click any gray dot to add that storm to comparison</p>
            <div id="timeSeriesChart" style="height: 650px;"></div>
        </div>
        
        <!-- Bar Chart -->
    </div>

    <script>
        // Global variables
        let selectedStorms = [null, null, null];
        const allStorms = ATLANTIC_STORMS_ENHANCED;
        
        // Major storms for quick selection
        const majorStorms = allStorms
            .filter(s => s.rc_impact_score >= 60 || s.category >= 3)
            .sort((a, b) => b.rc_impact_score - a.rc_impact_score);

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            populateStormSelectors();
            updateComparisonChart();
            updateScatterChart();
            updateTimeSeriesChart();
        });

        // Populate storm selectors with search capability
        function populateStormSelectors() {
            const selectors = ['storm1Select', 'storm2Select', 'storm3Select'];
            
            // Get Category 1-5 hurricanes with landfall, sorted newest first
            const landfallHurricanes = allStorms
                .filter(s => s.category >= 1 && s.category <= 5 && s.landfall_states && s.landfall_states.length > 0)
                .sort((a, b) => {
                    // Sort by year descending (newest first)
                    if (b.year !== a.year) return b.year - a.year;
                    // Then by month descending
                    if (b.month !== a.month) return b.month - a.month;
                    // Then by day descending
                    return (b.day || 0) - (a.day || 0);
                });
            
            selectors.forEach((selectorId, idx) => {
                const select = document.getElementById(selectorId);
                
                // Replace select with searchable input using datalist
                const searchInput = document.createElement('input');
                searchInput.type = 'text';
                searchInput.placeholder = 'Type to search storms...';
                searchInput.className = 'w-full px-3 py-2 border rounded-lg text-sm';
                searchInput.id = selectorId + 'Search';
                searchInput.setAttribute('list', selectorId + 'List');
                
                // Create datalist for autocomplete
                const dataList = document.createElement('datalist');
                dataList.id = selectorId + 'List';
                
                // Hide original select
                select.style.display = 'none';
                
                // Insert search input and datalist
                select.parentNode.insertBefore(searchInput, select);
                select.parentNode.insertBefore(dataList, select);
                
                // Clear existing options
                select.innerHTML = '';
                
                // Add default option
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = '-- Select a Hurricane (Cat 1-5 with landfall) --';
                select.appendChild(defaultOption);
                
                // Populate datalist with all storms
                landfallHurricanes.forEach(storm => {
                    const option = document.createElement('option');
                    option.value = `${storm.name} (${storm.year}) - Cat ${storm.category}`;
                    option.setAttribute('data-storm-id', storm.storm_id);
                    dataList.appendChild(option);
                    
                    // Also add to hidden select for compatibility
                    const selectOption = document.createElement('option');
                    selectOption.value = storm.storm_id;
                    selectOption.textContent = `${storm.name} (${storm.year}) - Cat ${storm.category}`;
                    select.appendChild(selectOption);
                });
                
                // Handle input change
                searchInput.addEventListener('input', function() {
                    const selectedText = this.value;
                    // Find matching storm
                    const matchingStorm = landfallHurricanes.find(storm => 
                        `${storm.name} (${storm.year}) - Cat ${storm.category}` === selectedText
                    );
                    if (matchingStorm) {
                        select.value = matchingStorm.storm_id;
                        select.dispatchEvent(new Event('change'));
                    }
                });
            });
        }

        // Select storm
        function selectStorm(position) {
            const selectId = `storm${position}Select`;
            const stormId = document.getElementById(selectId).value;
            
            if (stormId) {
                const storm = allStorms.find(s => s.storm_id === stormId);
                selectedStorms[position - 1] = storm;
                updateStormCard(position, storm);
                
                if (position === 1) {
                    findSimilarStorms(storm);
                    predictResources(storm);
                    showTCRLinks(storm);
                }
            } else {
                selectedStorms[position - 1] = null;
                resetStormCard(position);
            }
            
            updateComparisonChart();
            updateScatterChart();
            updateTimeSeriesChart();
        }

        // Update storm card
        function updateStormCard(position, storm) {
            const card = document.getElementById(`storm${position}Card`);
            
            const impactColor = getImpactColor(storm.rc_impact_score);
            
            card.innerHTML = `
                <div class="mb-4">
                    <h3 class="text-xl font-bold">${storm.name}</h3>
                    <p class="text-gray-600">${storm.year} - ${storm.storm_id}</p>
                </div>
                
                <div class="impact-meter mb-4">
                    <div class="impact-fill" style="width: ${storm.rc_impact_score}%; background: ${impactColor}">
                        ${storm.rc_impact_score}
                    </div>
                </div>
                
                <div class="storm-metrics">
                    <div class="storm-metric">
                        <strong>Category:</strong> ${storm.category === 0 ? 'TS' : storm.category}
                    </div>
                    <div class="storm-metric">
                        <strong>Wind:</strong> ${storm.wind_mph} mph
                    </div>
                    <div class="storm-metric">
                        <strong>Pressure:</strong> ${storm.pressure || 'N/A'} mb
                    </div>
                    <div class="storm-metric">
                        <strong>States:</strong> ${storm.landfall_states?.join(', ') || 'None'}
                    </div>
                    <div class="storm-metric">
                        <strong>Deaths:</strong> ${storm.deaths || 0}
                    </div>
                    <div class="storm-metric">
                        <strong>Damage:</strong> ${storm.damage_millions ? '$' + storm.damage_millions.toLocaleString() + 'M' : 'N/A'}
                    </div>
                    <div class="storm-metric">
                        <strong>Impact Level:</strong> 
                        <span class="font-bold" style="color: ${impactColor}">${storm.rc_impact_level}</span>
                    </div>
                    <div class="storm-metric">
                        <strong>RC Response:</strong> ${storm.rc_response?.responded ? 'Yes' : 'No'}
                    </div>
                </div>
                
                ${storm.resources?.tcr_pdf ? `
                    <div class="mt-4">
                        <a href="${storm.resources.tcr_pdf}" target="_blank" class="tcr-button">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                      d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                                </path>
                            </svg>
                            View TCR Report
                        </a>
                    </div>
                ` : ''}
            `;
        }

        // Reset storm card
        function resetStormCard(position) {
            const card = document.getElementById(`storm${position}Card`);
            card.innerHTML = `
                <div class="text-center text-gray-500 py-8">
                    <svg class="w-16 h-16 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                    </svg>
                    <p>Select a storm</p>
                </div>
            `;
        }

        // Find similar storms
        function findSimilarStorms(storm) {
            const similarStorms = allStorms
                .filter(s => s.storm_id !== storm.storm_id)
                .map(s => {
                    // Calculate similarity score
                    let score = 0;
                    
                    // Category similarity (40 points)
                    const catDiff = Math.abs(s.category - storm.category);
                    score += Math.max(0, 40 - catDiff * 10);
                    
                    // Wind speed similarity (30 points)
                    const windDiff = Math.abs((s.wind_mph || 0) - (storm.wind_mph || 0));
                    score += Math.max(0, 30 - windDiff / 5);
                    
                    // Month similarity (20 points)
                    const monthDiff = Math.abs(s.month - storm.month);
                    score += Math.max(0, 20 - monthDiff * 5);
                    
                    // Landfall state overlap (10 points max)
                    if (s.landfall_states && storm.landfall_states) {
                        const overlap = s.landfall_states.filter(state => 
                            storm.landfall_states.includes(state)
                        ).length;
                        // Cap at 10 points total for state overlap
                        score += Math.min(10, overlap * 5);
                    }
                    
                    // Ensure score never exceeds 100
                    return { storm: s, score: Math.min(100, Math.round(score)) };
                })
                .filter(s => s.score > 50)
                .sort((a, b) => b.score - a.score)
                .slice(0, 5);
            
            const patternSection = document.getElementById('patternSection');
            const listDiv = document.getElementById('similarStormsList');
            
            if (similarStorms.length > 0) {
                patternSection.style.display = 'block';
                
                listDiv.innerHTML = similarStorms.map(match => `
                    <div class="similar-storm" onclick="selectSimilarStorm('${match.storm.storm_id}')">
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="font-bold">${match.storm.name} (${match.storm.year})</h4>
                                <p class="text-sm text-gray-600">
                                    Category ${match.storm.category} ‚Ä¢ ${match.storm.wind_mph} mph ‚Ä¢ 
                                    ${match.storm.landfall_states?.join(', ') || 'No US landfall'}
                                </p>
                                ${match.storm.deaths ? `<p class="text-sm text-red-600">${match.storm.deaths} deaths</p>` : ''}
                            </div>
                            <span class="match-score">${match.score}% match</span>
                        </div>
                    </div>
                `).join('');
            } else {
                patternSection.style.display = 'none';
            }
        }

        // Select similar storm for comparison
        function selectSimilarStorm(stormId) {
            // Find first empty slot or use slot 2
            if (!selectedStorms[1]) {
                document.getElementById('storm2Select').value = stormId;
                selectStorm(2);
            } else if (!selectedStorms[2]) {
                document.getElementById('storm3Select').value = stormId;
                selectStorm(3);
            } else {
                document.getElementById('storm2Select').value = stormId;
                selectStorm(2);
            }
        }

        // Predict resources
        function predictResources(storm) {
            const predictionSection = document.getElementById('predictionSection');
            
            if (storm) {
                predictionSection.style.display = 'block';
                
                // Base predictions on category and impact score
                const baseShelters = storm.category * 15 + (storm.rc_impact_score / 2);
                const baseMeals = storm.category * 50000 + (storm.rc_impact_score * 1000);
                const baseVolunteers = storm.category * 200 + (storm.rc_impact_score * 5);
                const baseCost = storm.category * 2 + (storm.rc_impact_score / 10);
                
                // Add randomness for realism
                const shelters = Math.round(baseShelters * (0.8 + Math.random() * 0.4));
                const meals = Math.round(baseMeals * (0.8 + Math.random() * 0.4));
                const volunteers = Math.round(baseVolunteers * (0.8 + Math.random() * 0.4));
                const cost = (baseCost * (0.8 + Math.random() * 0.4)).toFixed(1);
                
                document.getElementById('predictedShelters').textContent = shelters;
                document.getElementById('predictedMeals').textContent = (meals / 1000).toFixed(0) + 'K';
                document.getElementById('predictedVolunteers').textContent = volunteers.toLocaleString();
                document.getElementById('predictedCost').textContent = '$' + cost + 'M';
            } else {
                predictionSection.style.display = 'none';
            }
        }

        // Show TCR links
        function showTCRLinks(storm) {
            const tcrSection = document.getElementById('tcrSection');
            const linksDiv = document.getElementById('tcrLinks');
            
            if (storm && storm.resources) {
                tcrSection.style.display = 'block';
                
                const links = [];
                
                if (storm.resources.tcr_pdf) {
                    links.push(`
                        <a href="${storm.resources.tcr_pdf}" target="_blank" class="tcr-button">
                            üìÑ PDF Report
                        </a>
                    `);
                }
                
                if (storm.resources.tcr_kmz) {
                    links.push(`
                        <a href="${storm.resources.tcr_kmz}" target="_blank" class="tcr-button" style="background: #3b82f6;">
                            üåç Google Earth (KMZ)
                        </a>
                    `);
                }
                
                if (storm.resources.tcr_shp) {
                    links.push(`
                        <a href="${storm.resources.tcr_shp}" target="_blank" class="tcr-button" style="background: #8b5cf6;">
                            üìç GIS Shapefile
                        </a>
                    `);
                }
                
                if (storm.resources.nhc_archive) {
                    links.push(`
                        <a href="${storm.resources.nhc_archive}" target="_blank" class="tcr-button" style="background: #f59e0b;">
                            üìö NHC Archive
                        </a>
                    `);
                }
                
                linksDiv.innerHTML = links.join('');
            } else {
                tcrSection.style.display = 'none';
            }
        }

        // Update comparison chart
        function updateComparisonChart() {
            const validStorms = selectedStorms.filter(s => s !== null);
            
            const chartDiv = document.getElementById('comparisonChart');
            if (!chartDiv) {
                console.error('Chart div not found');
                return;
            }
            
            if (validStorms.length === 0) {
                Plotly.purge('comparisonChart');
                chartDiv.innerHTML = '<div class="text-center text-gray-500 mt-20">Select storms to compare</div>';
                return;
            }
            
            const traces = [];
            // Use real data factors
            const categories = ['Wind Speed', 'Pressure', 'ACE Index', 'Category', 'Deaths', 'States Hit', 'Peak Month'];
            
            validStorms.forEach((storm, index) => {
                // Calculate real values
                const windNorm = (storm.wind_mph || 0) / 200 * 100; // Max wind ~200mph
                const pressureNorm = storm.pressure ? ((1013 - storm.pressure) / 113) * 100 : 50; // 900-1013mb range
                const aceNorm = Math.min((storm.ace || 0) / 80 * 100, 100); // ACE max ~80
                const categoryNorm = (storm.category / 5) * 100; // Category 0-5
                const deathsNorm = Math.min(Math.log10((storm.deaths || 1) + 1) / 4 * 100, 100); // Log scale for deaths
                const statesNorm = ((storm.landfall_states?.length || 0) / 5) * 100; // Max ~5 states
                const monthNorm = ((storm.month - 1) / 11) * 100; // Month 1-12 normalized
                
                traces.push({
                    type: 'scatterpolar',
                    r: [windNorm, pressureNorm, aceNorm, categoryNorm, deathsNorm, statesNorm, monthNorm],
                    theta: categories,
                    fill: 'toself',
                    name: `${storm.name} (${storm.year})`,
                    marker: { color: ['#dc2626', '#f59e0b', '#10b981'][index] },
                    opacity: 0.6,
                    hovertemplate: `<b>${storm.name} (${storm.year})</b><br>` +
                        'Wind: ' + storm.wind_mph + ' mph<br>' +
                        'Pressure: ' + (storm.pressure || 'N/A') + ' mb<br>' +
                        'ACE: ' + (storm.ace?.toFixed(1) || 'N/A') + '<br>' +
                        'Category: ' + storm.category + '<br>' +
                        'Deaths: ' + (storm.deaths || 0) + '<br>' +
                        'States: ' + (storm.landfall_states?.join(', ') || 'None') + '<br>' +
                        'Month: ' + storm.month + '<extra></extra>'
                });
            });
            
            // Only create annotations if storms are selected
            const annotations = validStorms.length > 0 ? validStorms.map((storm, index) => ({
                x: 0.5,
                y: -0.08 - (index * 0.03),
                xref: 'paper',
                yref: 'paper',
                text: `<span style="color:${['#dc2626', '#f59e0b', '#10b981'][index]}">‚ñ†</span> ${storm.name} (${storm.year})`,
                showarrow: false,
                font: { size: 12 },
                xanchor: 'center'
            })) : [];
            
            const layout = {
                polar: {
                    radialaxis: {
                        visible: true,
                        range: [0, 100],
                        ticksuffix: '%',
                        gridcolor: '#e5e7eb'
                    },
                    angularaxis: {
                        gridcolor: '#e5e7eb'
                    },
                    bgcolor: '#f9fafb'
                },
                showlegend: false,
                title: {
                    text: 'Multi-Factor Storm Analysis',
                    font: { size: 16 }
                },
                height: 650,
                margin: { t: 70, r: 100, b: 140, l: 100 },
                paper_bgcolor: 'white',
                font: { family: 'system-ui, sans-serif' },
                annotations: annotations
            };
            
            const config = {
                responsive: true,
                displayModeBar: false
            };
            
            Plotly.newPlot('comparisonChart', traces, layout, config);
        }

        // Helper function
        function getImpactColor(score) {
            if (score >= 80) return '#7f1d1d';
            if (score >= 60) return '#dc2626';
            if (score >= 40) return '#f59e0b';
            if (score >= 20) return '#10b981';
            return '#3b82f6';
        }
        
        // Add Scatter Chart function
        function updateScatterChart() {
            const validStorms = selectedStorms.filter(s => s !== null);
            const chartDiv = document.getElementById('scatterChart');
            if (!chartDiv) return;
            
            if (validStorms.length === 0) {
                Plotly.purge('scatterChart');
                chartDiv.innerHTML = '<div class="text-center text-gray-500 mt-20">Select storms to analyze</div>';
                return;
            }
            
            // Add all hurricanes as background context
            const backgroundStorms = allStorms.filter(s => 
                s.category >= 1 && s.pressure && s.wind_mph && 
                s.landfall_states && s.landfall_states.length > 0
            );
            
            const traces = [{
                x: backgroundStorms.map(s => s.pressure),
                y: backgroundStorms.map(s => s.wind_mph),
                mode: 'markers',
                type: 'scatter',
                name: 'All Hurricanes',
                showlegend: false,  // Hide from legend to reduce clutter
                marker: {
                    size: 9,  // 50% bigger (was 6)
                    color: '#4b5563',  // Darker gray (was #6b7280)
                    opacity: 0.7  // Slightly more opaque
                },
                hovertemplate: '<b>%{text}</b><br>Wind: %{y} mph<br>Pressure: %{x} mb<extra></extra>',
                text: backgroundStorms.map(s => `${s.name} (${s.year})`)
            }];
            
            // Add text labels for major storms (visible when zoomed)
            const majorBackgroundStorms = backgroundStorms.filter(s => s.category >= 4 || s.wind_mph >= 150);
            if (majorBackgroundStorms.length > 0) {
                traces.push({
                    x: majorBackgroundStorms.map(s => s.pressure),
                    y: majorBackgroundStorms.map(s => s.wind_mph),
                    mode: 'text',
                    type: 'scatter',
                    showlegend: false,
                    text: majorBackgroundStorms.map(s => s.name),
                    textfont: {
                        size: 8,
                        color: '#374151'
                    },
                    textposition: 'top center',
                    hoverinfo: 'skip'
                });
            }
            
            // Add selected storms
            validStorms.forEach((storm, index) => {
                if (storm.pressure && storm.wind_mph) {
                    traces.push({
                        x: [storm.pressure],
                        y: [storm.wind_mph],
                        mode: 'markers+text',
                        type: 'scatter',
                        name: `${storm.name} (${storm.year})`,
                        text: [storm.name],
                        textposition: 'top center',
                        marker: {
                            size: 15,
                            color: ['#dc2626', '#f59e0b', '#10b981'][index],
                            line: { color: 'white', width: 2 }
                        },
                        hovertemplate: `<b>${storm.name} (${storm.year})</b><br>` +
                            `Wind: ${storm.wind_mph} mph<br>` +
                            `Pressure: ${storm.pressure} mb<br>` +
                            `Category: ${storm.category}<extra></extra>`
                    });
                }
            });
            
            const layout = {
                title: 'Wind-Pressure Relationship',
                xaxis: {
                    title: 'Minimum Pressure (mb)',
                    autorange: 'reversed',
                    gridcolor: '#e5e7eb'
                },
                yaxis: {
                    title: 'Maximum Wind Speed (mph)',
                    gridcolor: '#e5e7eb'
                },
                height: 650,
                showlegend: false,
                margin: { t: 70, r: 70, b: 140, l: 70 },
                hovermode: 'closest',
                paper_bgcolor: 'white',
                plot_bgcolor: '#f9fafb'
            };
            
            Plotly.newPlot('scatterChart', traces, layout, { responsive: true, displayModeBar: false });
            
            // Add click handler for storm details
            document.getElementById('scatterChart').on('plotly_click', function(data) {
                if (data.points && data.points[0]) {
                    const point = data.points[0];
                    if (point.data.name === 'All Hurricanes') {
                        const stormIndex = point.pointIndex;
                        const storm = backgroundStorms[stormIndex];
                        if (storm) {
                            // Show storm in first empty slot or replace first slot
                            if (!selectedStorms[0]) {
                                document.getElementById('storm1Select').value = storm.storm_id;
                                selectStorm(1);
                            } else if (!selectedStorms[1]) {
                                document.getElementById('storm2Select').value = storm.storm_id;
                                selectStorm(2);
                            } else if (!selectedStorms[2]) {
                                document.getElementById('storm3Select').value = storm.storm_id;
                                selectStorm(3);
                            }
                        }
                    }
                }
            });
        }
        
        // Add Time Series Chart
        function updateTimeSeriesChart() {
            const validStorms = selectedStorms.filter(s => s !== null);
            const chartDiv = document.getElementById('timeSeriesChart');
            if (!chartDiv) return;
            
            if (validStorms.length === 0) {
                Plotly.purge('timeSeriesChart');
                chartDiv.innerHTML = '<div class="text-center text-gray-500 mt-20">Select storms to see trends</div>';
                return;
            }
            
            // Get historical context - similar category storms
            const traces = [];
            
            // Add background context - all similar category storms
            const backgroundStorms = allStorms.filter(s => 
                s.category >= 1 && s.category <= 5 &&
                s.landfall_states && s.landfall_states.length > 0 &&
                s.wind_mph
            );
            
            traces.push({
                x: backgroundStorms.map(s => s.year),
                y: backgroundStorms.map(s => s.wind_mph),
                mode: 'markers',
                type: 'scatter',
                name: 'All Cat 1-5 Hurricanes',
                showlegend: false,  // Hide from legend to reduce clutter
                marker: {
                    size: 9,  // 50% bigger (was 6)
                    color: '#6b7280',  // Darker gray (was #9ca3af)
                    opacity: 0.6  // More opaque
                },
                hovertemplate: '<b>%{text}</b><br>Year: %{x}<br>Wind: %{y} mph<extra></extra>',
                text: backgroundStorms.map(s => `${s.name}`)
            });
            
            // Add labels for Category 5 storms
            const cat5Storms = backgroundStorms.filter(s => s.category === 5);
            if (cat5Storms.length > 0) {
                traces.push({
                    x: cat5Storms.map(s => s.year),
                    y: cat5Storms.map(s => s.wind_mph),
                    mode: 'text',
                    type: 'scatter',
                    showlegend: false,
                    text: cat5Storms.map(s => s.name),
                    textfont: {
                        size: 8,
                        color: '#7c3aed'  // Purple for Cat 5
                    },
                    textposition: 'top center',
                    hoverinfo: 'skip',
                    texttemplate: '%{text}',
                    // Add offset to move text higher
                    y: cat5Storms.map(s => s.wind_mph + 5)  // Move labels 5 mph higher
                });
            }
            
            // Add selected storms with larger markers
            validStorms.forEach((storm, index) => {
                // Add the marker
                traces.push({
                    x: [storm.year],
                    y: [storm.wind_mph],
                    mode: 'markers',
                    type: 'scatter',
                    name: `${storm.name} (${storm.year})`,
                    marker: {
                        size: 15,
                        color: ['#dc2626', '#f59e0b', '#10b981'][index],
                        line: { color: 'white', width: 2 }
                    },
                    hovertemplate: `<b>${storm.name} (${storm.year})</b><br>` +
                        `Wind: ${storm.wind_mph} mph<br>` +
                        `Category: ${storm.category}<extra></extra>`,
                    showlegend: false
                });
                
                // Add the text label separately with offset
                traces.push({
                    x: [storm.year],
                    y: [storm.wind_mph + 7],  // Move label 7 mph higher
                    mode: 'text',
                    type: 'scatter',
                    text: [storm.name],
                    textposition: 'top center',
                    textfont: {
                        size: 10,
                        color: ['#dc2626', '#f59e0b', '#10b981'][index],
                        family: 'Arial, sans-serif',
                        weight: 'bold'
                    },
                    hoverinfo: 'skip',
                    showlegend: false
                });
            });
            
            const layout = {
                title: 'Historical Intensity Context',
                xaxis: { title: 'Year', gridcolor: '#e5e7eb' },
                yaxis: { title: 'Wind Speed (mph)', gridcolor: '#e5e7eb' },
                height: 650,
                showlegend: false,
                margin: { t: 70, r: 70, b: 140, l: 70 },
                paper_bgcolor: 'white',
                plot_bgcolor: '#f9fafb'
            };
            
            Plotly.newPlot('timeSeriesChart', traces, layout, { responsive: true, displayModeBar: false });
            
            // Add click handler for storm selection
            document.getElementById('timeSeriesChart').on('plotly_click', function(data) {
                if (data.points && data.points[0]) {
                    const point = data.points[0];
                    if (point.data.name === 'All Cat 1-5 Hurricanes') {
                        const stormIndex = point.pointIndex;
                        const storm = backgroundStorms[stormIndex];
                        if (storm && !selectedStorms.find(s => s && s.storm_id === storm.storm_id)) {
                            // Add to next available slot
                            for (let i = 0; i < 3; i++) {
                                if (!selectedStorms[i]) {
                                    document.getElementById(`storm${i+1}Select`).value = storm.storm_id;
                                    selectStorm(i+1);
                                    break;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Auto-select some storms for demo
        setTimeout(() => {
            // Select Katrina as primary
            const katrina = allStorms.find(s => s.name === 'KATRINA' && s.year === 2005);
            if (katrina) {
                document.getElementById('storm1Select').value = katrina.storm_id;
                selectStorm(1);
            }
        }, 500);
    </script>
</body>
</html>